---
title: "ODD protocol"
output: 
  md_document:
    toc: TRUE
  word_document:
    reference_docx: style-template.docx
    toc: TRUE
  rtf_document:
    toc: TRUE
  pdf_document:
    latex_engine: xelatex
    toc: TRUE
    keep_md: TRUE
    keep_tex: TRUE
params:
  format: "word"
bibliography: RS_ODD.json
csl: ecography.csl
---
`r if(params$format!="md"){"
<style>
body {
text-align: justify}
</style>"}`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# global output settings
output_format <- params$format

# Environmental stochasticity
environmental_stochasticity <- F
env_stoch_loc <- F
env_stoch_K <- F
env_stoch_R <- F

# Outputs
output_range <- F
output_occ <- F
output_pop <- F
output_ind <- F
output_conn <- F
output_paths <- F
output_heatmaps <-F

# landscape parameters
local_ext_prob <- F
arti_land <- F
arti_land_continuous <- F
real_land <- F
cell_based <- FALSE
patch_based <- F
habitat_type <- FALSE
habitat_quality <- F
dynamic_landscape <- F
resolution <- ""

#population dynamics
stage_structured <- F
sexual <- F
only_female <- F
asexual <- F
rep_seasons <- 1
rep_interval <- 0
mating_simple <- F
mating_complex <- F
demography_sexdep <- F
repro_densdep <- F
repro_stagedep <- F
survival_densdep <- F
survival_stagedep <- F
survival_schedule <- 1
develop_densdep <- F
develop_stagedep <- F

# transfer TODO: check ups, e.g. if SMS T -> movement_model T
dispersal_kernel <- F
dispersal_kernel_simple <- F
dispersal_kernel_mixed <- F
movement_model <- F
movement_SMS <- F
movement_corrRW <- F
movement_cost <- F
movement_cost_file <- F
movement_SMS_PRmethod <- 0
goal_type <- 0

# settlement
max_steps <- F
min_steps <- F
step_mortality <- F
mate_finding <- F
settlement_densdep <- F
settlement_stagedep <- F
settlement_sexdep <- F

# emigration
emigration_densdep <- F
emigration_sexdep <- F
emigration_stagedep <- F


```

```{r, echo =FALSE}
# environmental stochasticity
if(s@simul@EnvStoch==0) environmental_stochasticity <- F
if(s@simul@EnvStoch==1) {environmental_stochasticity <- T; env_stoch_loc <- F}
if(s@simul@EnvStoch==2) {environmental_stochasticity <- T; env_stoch_loc <- T}
if(s@simul@EnvStochType==0) {env_stoch_R <- T; env_stoch_K <- F}
if(s@simul@EnvStochType==1) {env_stoch_R <- F; env_stoch_K <- T}

# outputs
if(s@simul@OutIntRange>=1) output_range <- T
if(s@simul@OutIntOcc>=1) output_occ <- T
if(s@simul@OutIntPop>=1) output_pop <- T
if(s@simul@OutIntInd>=1) output_ind <- T
if(s@simul@OutIntConn>=1) output_conn <- T
if(s@simul@OutIntPaths>=1) output_paths <- T
if(s@simul@SMSHeatMap>=1) output_heatmaps <- T

# landscape
if(class(s@land)=="ArtificialLandscape") {
  arti_land <- T
  if (s@land@continuous) arti_land_continuous <- T
  }
if(class(s@land)=="ImportedLandscape") real_land <- T
if(class(s@land)=="ImportedLandscape" & length(s@land@DynamicLandYears)>1) dynamic_landscape <- T
if(length(s@land@PatchFile)==0) cell_based <- T
if(length(s@land@PatchFile)!=0) patch_based <- T
if(s@land@HabPercent) habitat_quality <- T else habitat_type <- T
if(s@simul@LocalExt) local_ext_prob <- T

resolution <- paste(s@land@Resolution, "m x ", s@land@Resolution,"m", sep="")

# demography
if(s@demog@ReproductionType==0) {asexual <- T; only_female <- T}
if(s@demog@ReproductionType==1) {sexual <- T; mating_simple <- T}
if(s@demog@ReproductionType==2) {sexual <- T; mating_complex <- T}
if(s@demog@Rmax<0){
  stage_structured <- T
  survival_schedule <- s@demog@StageStruct@SurvSched
  rep_seasons <- s@demog@StageStruct@RepSeasons
  rep_interval <- s@demog@StageStruct@RepInterval
  if(s@demog@StageStruct@FecDensDep) repro_densdep <- T
  if(s@demog@StageStruct@SurvDensDep) survival_densdep <- T
  if(s@demog@StageStruct@DevDensDep) develop_densdep <- T
  if(s@demog@StageStruct@FecStageWts) repro_stagedep <- T
  if(s@demog@StageStruct@SurvStageWts) survival_stagedep <- T
  if(s@demog@StageStruct@DevStageWts) develop_stagedep <- T
}

# dispersal
# emigration
if(s@dispersal@Emigration@DensDep) emigration_densdep <- T
if(s@dispersal@Emigration@SexDep) emigration_sexdep <- T
if(s@dispersal@Emigration@StageDep) emigration_stagedep <- T

# transfer
if(class(s@dispersal@Transfer)=="DispersalKernel") {
  dispersal_kernel <- T
  if(s@dispersal@Transfer@DoubleKernel) {dispersal_kernel_mixed <- T} else {dispersal_kernel_simple <- T}
}
if(class(s@dispersal@Transfer)=="CorrRW") {
  movement_model <- T
  movement_corrRW <- T
  if(length(s@dispersal@Transfer@StepMort)>1){
    step_mortality <- T
  } else if (s@dispersal@Transfer@StepMort>0){
    step_mortality <- T
  }
  if(s@dispersal@Settlement@MinSteps>0) min_steps <- T
  if(s@dispersal@Settlement@MaxSteps>0) max_steps <- T
} 

if(class(s@dispersal@Transfer)=="StochMove"){
  movement_model <- T
  movement_SMS <- T
  goal_type <- s@dispersal@Transfer@GoalType
  if(sum(s@dispersal@Transfer@Costs)>0) movement_cost <- T
  if(!is.null(s@land@CostsFile)) {movement_cost_file <- T; movement_cost <- T}
  if(length(s@dispersal@Transfer@StepMort)>1){
    step_mortality <- T
  } else if (s@dispersal@Transfer@StepMort>0){
    step_mortality <- T
  }
  movement_SMS_PRmethod <- s@dispersal@Transfer@PRMethod
  if(s@dispersal@Settlement@MinSteps>0) min_steps <- T
  if(s@dispersal@Settlement@MaxSteps>0) max_steps <- T
}

# settlement
if(s@dispersal@Settlement@DensDep) settlement_densdep <- T
if(s@dispersal@Settlement@SexDep) settlement_sexdep <- T
if(s@dispersal@Settlement@StageDep) settlement_stagedep <- T
if(any(s@dispersal@Settlement@FindMate)) mate_finding <- T

```



# Purpose and patterns

The RangeShifter model is a single species, spatially-explicit and stochastic individual-based model (IBM), built around the integration of two fundamental components: population dynamics and dispersal behaviour. 
In this specific use case, population dynamics, represented as `r if(stage_structured){"stage-structured, "}` `r if(only_female){"only-female populations, "}` `r if(stage_structured){"with overlapping generations, "}` and dispersal (explicitly modeled in its three phases of emigration, transfer and settlement`r if(settlement_densdep | emigration_densdep | settlement_sexdep | emigration_sexdep | settlement_sexdep | emigration_sexdep){" accounting for  "}``r if(settlement_densdep | emigration_densdep){"context dependency, "}``r if(settlement_sexdep | emigration_sexdep){"sex specificity, "}``r if(settlement_stagedep | emigration_stagedep){"stage specificity"}`) are played out on top of gridded multi-habitat landscape. 

`r if(environmental_stochasticity){"This landscape includes environmental stochasticity."}`

Individuals are the basic entity of the model. 

# Entities, state variables and scales

## Individuals

Individuals are the basic entities of the RangeShifter model. Each individual has a unique ID number and, in this specific use case, is defined by the following state variables:   

* status   

* initial (natal) and current location   

`r if (sexual){"* sex   \n"}`
* age `r if(stage_structured){" and stage"}`   

## Popuations

Populations are defined by the individuals occupying `r if (cell_based){"a single cell"}``r if(patch_based){"a single patch"}` and they represent the scale at which individuals interact and density dependencies act. Populations are characterized by their size and location`r if(sexual){" and by the number of individuals of each sex"}``r if(stage_structured){" and the number in each stage class"}`.

## Landscape units

The model runs over a grid-based map.   
In this specific use case, each cell stores `r if(habitat_type){"a particular land-cover type (which can be breeding habitat for the species or otherwise)"}``r if(habitat_quality){"a habitat quality index"}`. Each cell is defined as suitable or not suitable for a species based on the presence/absence of habitat, and it is characterized by a species’ nature of demographic density dependence. 
`r if(environmental_stochasticity & !movement_cost & !local_ext_prob){"An additional state variable is an environmental noise value $\\epsilon$."}`
`r if(!environmental_stochasticity & movement_cost & !local_ext_prob){"An additional state variable is the cost of movement through the cell."}`
`r if(!environmental_stochasticity & !movement_cost & local_ext_prob){"An additional state variable is the local extinction probability."}`
`r if(environmental_stochasticity & movement_cost & !local_ext_prob){"Additional state variables are: an environmental noise value $\\epsilon$, the cost of movement through the cell."}`
`r if(!environmental_stochasticity & movement_cost  & local_ext_prob){"Additional state variables are: the cost of movement through the cell and local extinction probability."}`
`r if(!environmental_stochasticity & !movement_cost  & local_ext_prob){"Additional state variables are: an environmental noise value $\\epsilon$ and local extinction probability."}`
`r if(environmental_stochasticity & movement_cost  & local_ext_prob){"Additional state variables are:an environmental noise value $\\epsilon$, the cost of movement through the cell and local extinction probability."}`


`r if(patch_based){"The model is patch-based. Each patch is a higher-level entity composed of a group of one or more cells (typically adjacent, although that is not a necessary condition). A patch is characterized by a unique ID number, the number of cells that it contains, a list of these cells’ coordinates and its maximum and minimum x and y coordinates. The species’ demographic density dependence is a characteristic of the patch and not of the cell."}`

`r if(habitat_type & output_format=="pdf"){"
$\\color{red}{\\text{You might want to add the land cover types here.}}$
"}`

`r if(habitat_type & output_format=="word"){
 "**You might want to add the land cover types here.**"
}`

`r if(habitat_type & output_format=="md"){
 "**You might want to add the land cover types here.**"
}`

## Spatial and temporal scales

The cell size (resolution) is `r resolution`. 
`r if(cell_based){"The cell resolution represents the spatial scale at which the two fundamental processes of population dynamics and dispersal occur. This means that the density dependency in the model"}``r if(cell_based & (repro_densdep | survival_densdep | emigration_densdep | settlement_densdep)){" (on "}``r if(cell_based & repro_densdep & !survival_densdep & !emigration_densdep & !settlement_densdep){" reproduction"}``r if(cell_based & !repro_densdep & survival_densdep & !emigration_densdep & !settlement_densdep){"survival"}``r if(cell_based & !repro_densdep & !survival_densdep & emigration_densdep & !settlement_densdep){"emigration"}``r if(cell_based & !repro_densdep & !survival_densdep & !emigration_densdep & settlement_densdep){"settlement"}``r if(cell_based & repro_densdep & survival_densdep & !emigration_densdep & !settlement_densdep){"reproduction and survival"}``r if(cell_based & repro_densdep & !survival_densdep & emigration_densdep & !settlement_densdep){"reproduction and emigration"}``r if(cell_based & repro_densdep & !survival_densdep & !emigration_densdep & settlement_densdep){"reproduction and settlement"}``r if(cell_based & !repro_densdep & survival_densdep & emigration_densdep & !settlement_densdep){"survival and emigration"}``r if(cell_based & !repro_densdep & survival_densdep & !emigration_densdep & settlement_densdep){"survival and settlement"}``r if(cell_based & !repro_densdep & !survival_densdep & emigration_densdep & settlement_densdep){"emigration and settlement"}``r if(cell_based & repro_densdep & survival_densdep & emigration_densdep & !settlement_densdep){"reproduction, survival and emigration"}``r if(cell_based & repro_densdep & survival_densdep & !emigration_densdep & settlement_densdep){"reproduction, survival and settlement"}``r if(cell_based & repro_densdep & !survival_densdep & emigration_densdep & settlement_densdep){"reproduction, emigration and settlement"}``r if(cell_based & !repro_densdep & survival_densdep & emigration_densdep & settlement_densdep){"survival, emigration and settlement"}``r if(cell_based & repro_densdep & survival_densdep & emigration_densdep & settlement_densdep){"reproduction, survival, emigration and settlement"}``r if(cell_based & (repro_densdep | survival_densdep | emigration_densdep | settlement_densdep)){")"}``r if(cell_based){" acts at the cell scale and the same scale is used as a single step unit for discrete movement models."}``r if(patch_based){"Two spatial scales are simultaneously represented in the patch-based model: the cell scale, which in this case is used just for the transfer phase of dispersal (movements) and the patch scale, at which the density dependencies are acting"}``r if(patch_based & (repro_densdep | survival_densdep | emigration_densdep | settlement_densdep)){" (on "}``r if(patch_based & repro_densdep & !survival_densdep & !emigration_densdep & !settlement_densdep){" reproduction"}``r if(patch_based & !repro_densdep & survival_densdep & !emigration_densdep & !settlement_densdep){"survival"}``r if(patch_based & !repro_densdep & !survival_densdep & emigration_densdep & !settlement_densdep){"emigration"}``r if(patch_based & !repro_densdep & !survival_densdep & !emigration_densdep & settlement_densdep){"settlement"}``r if(patch_based & repro_densdep & survival_densdep & !emigration_densdep & !settlement_densdep){"reproduction and survival"}``r if(patch_based & repro_densdep & !survival_densdep & emigration_densdep & !settlement_densdep){"reproduction and emigration"}``r if(patch_based & repro_densdep & !survival_densdep & !emigration_densdep & settlement_densdep){"reproduction and settlement"}``r if(patch_based & !repro_densdep & survival_densdep & emigration_densdep & !settlement_densdep){"survival and emigration"}``r if(patch_based & !repro_densdep & survival_densdep & !emigration_densdep & settlement_densdep){"survival and settlement"}``r if(patch_based & !repro_densdep & !survival_densdep & emigration_densdep & settlement_densdep){"emigration and settlement "}``r if(patch_based & repro_densdep & survival_densdep & emigration_densdep & !settlement_densdep){"reproduction, survival and emigration"}``r if(patch_based & repro_densdep & survival_densdep & !emigration_densdep & settlement_densdep){"reproduction, survival and settlement"}``r if(patch_based & repro_densdep & !survival_densdep & emigration_densdep & settlement_densdep){"reproduction, emigration and settlement"}``r if(patch_based & !repro_densdep & survival_densdep & emigration_densdep & settlement_densdep){"survival, emigration and settlement"}``r if(patch_based & repro_densdep & survival_densdep & emigration_densdep & settlement_densdep){"reproduction, survival, emigration and settlement"}``r if(patch_based & (repro_densdep | survival_densdep | emigration_densdep | settlement_densdep)){")"}``r if(patch_based){"."}`
There are three distinct temporal scales. The highest-level one has years as units`r if(environmental_stochasticity){" and represents the scale at which variations in the abiotic environment are modeled"}`.  The intermediate scale is the species’ reproductive season. The model simulates `r if(rep_seasons==1){"1 reproductive season"} else{cat(rep_seasons, "reproductive seasons")}` per year. `r if(movement_model){"Finally, the smallest time scale is represented by the number of steps that emigrants take during the movement phase of dispersal. This is determined by "}``r if(max_steps & !step_mortality){"the maximum number of steps."}``r if(!max_steps & step_mortality){"the per-step mortality."}``r if(max_steps & step_mortality){"the maximum number of steps and per-step mortality."}`

\newpage

# Process overview and scheduling

![General model workflow and schedule. The core of the model highlighted in blue is expanded in the flow chart in Fig. 2](./RSflowchart_big.pdf){height=70%}

\newpage

![General flowchart of the core model](./RSflowchart_detail.pdf){height=70%}

\newpage

`r if(stage_structured){"At the beginning of each year, reproduction is the first process to be modelled."}` `r if(stage_structured & survival_schedule==0){"Survival and development of all the stages (apart from stage 0) occur simultaneously with reproduction, followed by dispersal and finally survival and development of stage 0. Individuals age at the end of each year."}` `r if(stage_structured & survival_schedule==1){"Reproduction is followed by dispersal. After each reproductive season, survival and successive development of all the stages are modelled. Aging occurs at the end of the year."}` `r if(stage_structured & survival_schedule==2){"Reproduction is followed by dispersal after each reproductive event. Survival and development of all stages happen only at the end of all reproductive seasons, followed by aging at the end of the year."}`

# Design concepts

## Basic principles

`r if(arti_land){"### Fractal landscape

To generate fractal landscapes, the midpoint displacement algorithm [@saupeAlgorithmsRandomFractals1988] is applied, adapted to allow for the generation of elongated landscapes. This fractal method has proven useful as a null model to investigate population responses to landscape changes such as habitat loss and fragmentation [@withExtinctionThresholdsSpecies1999; @plotnickGeneralModelSimulating2002]. Fractal landscapes are characterized by possessing greater structure than a completely random landscape, but less than a completely deterministic one [@withApplicationNeutralLandscape1997]."}`

`r if(environmental_stochasticity){"### Environmental stochasticity

Temporal environmental stochasticity is a ubiquitous and fundamental factor affecting both ecological and evolutionary processes acting at all levels of biological organization, from individuals to ecosystems [@vasseurColorEnvironmentalNoise2004; @ruokolainenEcologicalEvolutionaryDynamics2009]. Importantly, it has been demonstrated to interact with the density dependence of a species’ demography to influence population dynamics profoundly, and, as consequence, extinction risk [@ruokolainenEcologicalEvolutionaryDynamics2009]. In particular, in unstructured populations, red noise (low frequency fluctuations) is predicted to increase extinction risk, especially in a population having under-compensatory dynamics [@ripaNoiseColourRisk1996; @johstExtinctionRiskTemporally1997; @schwagerDoesRedNoise2006; @heinoExtinctionRiskColoured2000a; @greenmanImpactEnvironmentalFluctuations2005; @fowlerConfoundingEnvironmentalColour2013]. This body of theory has focused on local populations, and there has been much less effort devoted to understanding how inter-annual variability influences species’ large-scale responses to climate change. One recent model shows that red noise can increase species’ regional extinction risks under periods of climate change [@mustinRedNoiseIncreases2013]. By incorporating inter-annual variability, RangeShifter provides an ideal platform for generating improved knowledge relating to eco-evolutionary responses to environmental changes in the presence of inter-annual variability.
There is evidence that inter-annual variability in weather is increasing and is expected to increase further and also to redden under climate change [@easterlingClimateExtremesObservations2000; @coumouDecadeWeatherExtremes2012; @hansenPerceptionClimateChange2012]. Despite its importance as a selective pressure and in determining a species’ extinction risk, especially for small fragmented populations already stressed by anthropogenic disturbances, environmental stochasticity has rarely been included in models that try to make predictions regarding species’ future distribution and persistence [@mclaughlinClimateChangeHastens2002; @verboomPopulationDynamicsIncreasing2010]. Please see the submodel description for further details."}`

### Population dynamics

Demographic stochasticity is fundamentally important for the dynamics of populations that are naturally small or have declined to low abundances owing to anthropogenic pressures. Additionally, inter-individual variability within populations can have a major influence on dynamics. Modelling stochastic events that happen to individuals is crucial for avoiding systematic overestimation of population viability or rate of spread [@clarkInvasionExtremesPopulation2001; @kendallUnstructuredIndividualVariation2003; @robertVariationIndividualsDemographic2003; @grimmIndividualbasedModelingEcology2005; @jongejansDispersalDemographySpatial2008; @travisImprovingPredictionManagement2011a]. Thus, population dynamics in RangeShifter were constructed to be fully individual-based and stochastic. Each reproductive individual produces a discrete number of offspring sampled from a Poisson distribution with a mean that is influenced by the species’ demographic parameters and the local population density.

### Definition of populations

`r if(cell_based){"The cell is the scale at which processes such as population dynamics and dispersal act. The individuals present in a cell define a distinct population, and density-dependencies "}``r if(cell_based & repro_densdep & emigration_densdep & settlement_densdep){"for reproduction, emigration and settlement all "}``r if(cell_based & repro_densdep & emigration_densdep & !settlement_densdep){"for reproduction and emigration both "}``r if(cell_based & repro_densdep & !emigration_densdep & settlement_densdep){"for reproduction and settlement both "}``r if(cell_based & !repro_densdep & emigration_densdep & settlement_densdep){"for emigration and settlement both "}``r if(cell_based & repro_densdep & !emigration_densdep & !settlement_densdep){"for reproduction "}``r if(cell_based & !repro_densdep & emigration_densdep & !settlement_densdep){"for emigration "}``r if(cell_based & !repro_densdep & !emigration_densdep & settlement_densdep){"for settlement "}``r if(cell_based){"operate at this scale. Even in the case where two habitat cells are adjacent, they still hold separate populations.

A cell-based model provides an excellent abstraction of space for many theoretical studies.
"}`

`r if(patch_based){"Population dynamics happen at the patch level, a patch being an assemblage of landscape cells of potentially different habitat types or quality. Patches are not defined automatically. Rather, the definition which cells belong to which patch is obtained by an additional patch file, taking into account the ecological understanding of the study species. Density-dependencies "}``r if(patch_based & repro_densdep & emigration_densdep & settlement_densdep & !develop_densdep & !survival_densdep){"regarding reproduction, emigration and settlement "}``r if(patch_based & repro_densdep & emigration_densdep & !settlement_densdep & !develop_densdep & !survival_densdep){"regarding reproduction and emigration "}``r if(patch_based & repro_densdep & !emigration_densdep & settlement_densdep & !develop_densdep & !survival_densdep){"regarding reproduction and settlement "}``r if(patch_based & !repro_densdep & emigration_densdep & settlement_densdep & !develop_densdep & !survival_densdep){"regarding emigration and settlement "}``r if(patch_based & repro_densdep & !emigration_densdep & !settlement_densdep & !develop_densdep & !survival_densdep){"regarding reproduction "}``r if(patch_based & !repro_densdep & emigration_densdep & !settlement_densdep & !develop_densdep & !survival_densdep){"regarding emigration "}``r if(patch_based & !repro_densdep & !emigration_densdep & settlement_densdep & !develop_densdep & !survival_densdep){"regarding settlement "}`

`r if(patch_based & repro_densdep & emigration_densdep & settlement_densdep & develop_densdep & !survival_densdep){"regarding reproduction, development, emigration and settlement "}``r if(patch_based & repro_densdep & emigration_densdep & settlement_densdep & !develop_densdep & survival_densdep){"regarding reproduction, emigration, settlement and survival "}``r if(patch_based & repro_densdep & emigration_densdep & settlement_densdep & develop_densdep & survival_densdep){"regarding reproduction, development, emigration, settlement and survival "}``r if(patch_based & repro_densdep & emigration_densdep & !settlement_densdep & !develop_densdep & survival_densdep){"regarding reproduction, emigration and survival "}``r if(patch_based & repro_densdep & emigration_densdep & !settlement_densdep & develop_densdep & !survival_densdep){"regarding reproduction, development and emigration "}``r if(patch_based & repro_densdep & emigration_densdep & !settlement_densdep & develop_densdep & survival_densdep){"regarding reproduction, development, emigration and survival "}``r if(patch_based & repro_densdep & !emigration_densdep & settlement_densdep & develop_densdep & !survival_densdep){"regarding reproduction,development and settlement "}``r if(patch_based & repro_densdep & !emigration_densdep & settlement_densdep & !develop_densdep & survival_densdep){"regarding reproduction, settlement and survival "}``r if(patch_based & repro_densdep & !emigration_densdep & settlement_densdep & develop_densdep & survival_densdep){"regarding reproduction, development, settlement and survival "}``r if(patch_based & !repro_densdep & emigration_densdep & settlement_densdep & !develop_densdep & survival_densdep){"regarding development, emigration and settlement "}``r if(patch_based & !repro_densdep & emigration_densdep & settlement_densdep & develop_densdep & !survival_densdep){"regarding emigration, settlement and survival "}``r if(patch_based & !repro_densdep & emigration_densdep & settlement_densdep & develop_densdep & survival_densdep){"regarding development, emigration, settlement and survival "}``r if(patch_based & repro_densdep & !emigration_densdep & !settlement_densdep & !develop_densdep & survival_densdep){"regarding reproduction and survival "}``r if(patch_based & repro_densdep & !emigration_densdep & !settlement_densdep & develop_densdep & !survival_densdep){"regarding reproduction and development "}``r if(patch_based & repro_densdep & !emigration_densdep & !settlement_densdep & develop_densdep & survival_densdep){"regarding reproduction, development and survival "}``r if(patch_based & !repro_densdep & emigration_densdep & !settlement_densdep & !develop_densdep & survival_densdep){"regarding emigration and survival "}``r if(patch_based & !repro_densdep & emigration_densdep & !settlement_densdep & develop_densdep & !survival_densdep){"regarding development and emigration "}``r if(patch_based & !repro_densdep & emigration_densdep & !settlement_densdep & develop_densdep & survival_densdep){"regarding development, emigration and survival "}``r if(patch_based & !repro_densdep & !emigration_densdep & settlement_densdep & !develop_densdep & survival_densdep){"regarding settlement and survival "}``r if(patch_based & !repro_densdep & !emigration_densdep & settlement_densdep & develop_densdep & !survival_densdep){"regarding development and settlement "}``r if(patch_based & !repro_densdep & !emigration_densdep & settlement_densdep & develop_densdep & survival_densdep){"regarding development, settlement and survival "}``r if(patch_based){"will depend on the density of individuals in a patch. However, discrete step-wise movements during the transfer phase will always use the cell as the resolution at which steps occur, thus retaining important information about the landscape heterogeneity.

The patch-based implementation allows separating the scales used for population dynamics and movements. In this case, the landscape can be modelled at very fine resolution in order to capture the features that are likely to influence movements (e.g. narrow linear features) without constraining the local population dynamics to operate at too small a scale."}`

`r if(!stage_structured){"### Population structure

Implementing non-overlapping generations which are not stage-structured is the appropriate way to model species that have discrete generations. At each generation the life cycle comprises: reproduction, death of the adults and offspring dispersal (in that order). These discrete generation models can be applied to asexual species, species for which it is assumed that females play the dominant role in spatial dynamics and for species for which it is considered crucial to model both sexes explicitly."}`

`r if(stage_structured){"### Population structure

Implementing overlapping generations which are stage-structured is the appropriate choice for species in which generations can overlap and individuals can be classified in different stages (e.g. immature vs. breeding individuals) differing in their demographic parameters. Individuals are characterized by their age and stage. Each stage has a certain fecundity, survival and probability of developing to the next stage. The parameters are provided through classical transition matrices [@caswellMatrixPopulationModels2001a]. However, in RangeShifter, these are not solved analytically as is typical for matrix models but, instead, the parameters are applied stochastically in an individual-based fashion. Presenting the demographic parameters in the standard matrix notation, Bocedi et al. [-@bocediRangeShifterPlatformModelling2014] believed to ease parameterization, as most population modellers are used to matrix models and, additionally, the number of parameters is kept to the minimum. It has the further important benefit of helping bridging the gap between analytical models and IBMs, the joint use of which has considerable potential, especially for improving modelling for conservation [@travisImprovingPredictionManagement2011a]."}`

### Dispersal

Dispersal is defined as movement leading to spatial gene flow, and it typically involves three phases: emigration, transfer and settlement [@stensethAnimalDispersalSmall1992; @clobertDispersal2001; @bowlerCausesConsequencesAnimal2005a; @ronceHowDoesIt2007a]. The key role of dispersal in species persistence and responses to environmental change is increasingly recognized [@travisDispersalSpeciesResponses2014]. Moreover, the importance of modelling dispersal as a complex process, explicitly considering its three phases, each of which has its own mechanisms and costs, has been recently highlighted [@bonteCostsDispersal2012a; @travisModellingDispersalEcoevolutionary2012a; @travisDispersalSpeciesResponses2014]. The implementation of the dispersal process in RangeShifter is based on these recent frameworks and the substantial dispersal theory that has been developed so far [@clobertDispersalEcologyEvolution2012a].

#### Emigration

Emigration is the first phase of dispersal. Emigration itself can be a complex process determined by multiple proximate and ultimate causes. Multiple emigration strategies can be present across the species’ range, inside a single population or even within the same individual in form of plastic emigration behaviour.

The theory on emigration accounts for context dependencies, plasticity and inter-individual variability in emigration strategies. Much work has been conducted to understand the role of density dependence in emigration [@travisEvolutionDensitydependentDispersal1999; @metzHowShouldWe2001; @poethkeEvolutionDensityPatch2002;@matthysenDensitydependentDispersalBirds2005; @kunEvolutionDensityDependentDispersal2006; @chaput-bardyConditionPhenotypeDependentDispersal2010; @demeesterInformationUseDensitydependent2010]. 

In RangeShifter, emigration is modelled as the probability that an individual will leave its natal patch during the present year (or season). See the description of the submodel for further details.

#### Transfer

Transfer is the second phase of dispersal, and consists of the movement of an individual starting from when it emigrates from its natal patch and ending with settlement in another patch or mortality. The main components of this phase are the individual movement ability and navigation capacity in response to the characteristics of the environment. The interaction between these components and their associated costs will determine the distance moved, the movement path and the chance of surviving the transfer phase.

Understanding and modelling how species move is not a simple task, and, perhaps more than for the other phases of dispersal, much effort has been spent in two separate and not always interacting fields: dispersal ecology [@travisMechanisticUnderstandingDispersal2010] and movement ecology [@nathanMovementEcologyParadigm2008a]. While the former seeks to understand movements as a part of the dispersal process and has often described transfer with phenomenological dispersal kernels (but see recent developments in fitting mechanistic kernels: [@schurrHowRandomDispersal2012]), the latter is more focused on understanding the mechanisms of the movement process itself, even though recent emphasis has been put on the consequences of movements for population dynamics [@moralesBuildingBridgeAnimal2010a]. Modelling dispersal in IBMs needs to draw from both fields.

`r if(dispersal_kernel){"
Phenomenological dispersal kernels were used to model the transfer phase.Dispersal kernels are statistical distributions that are largely used to describe dispersal distances. For a comprehensive review about theory and empirical estimation of dispersal kernels we refer to Clobert et al. [-@clobertDispersalEcologyEvolution2012a], Part IV.

Dispersal kernels have been largely used in dispersal ecology both for describing dispersal patterns and for theoretical studies, as well as in metapopulation theory. Recently they have been incorporated in species distribution models [@travisDispersalSpeciesResponses2014], either at population or individual level [@keithPredictingExtinctionRisks2008; @andersonDynamicsRangeMargins2009; @englerMigClimPredictingPlant2009; @willisDynamicDistributionModelling2009; @mitikkaRangeExpansionEuropean2010; @boulangeatAccountingDispersalBiotic2012; @pagelForecastingSpeciesRanges2012a; @schurrHowUnderstandSpecies2012]. The main assumption behind dispersal kernels is that the principal determinant of the probability of an individual dispersing to a particular site is the distance from the starting location. However, it is well recognized and supported by data [@hovestadtEvolutionEmergenceDispersal2012; @baguetteIndividualDispersalLandscape2013], that in most cases realized kernels are the results of multiple factors, such as the interaction between individual movement capacity and landscape structure, making Euclidean distance a poor predictor of dispersal. Dispersal kernels are not a fixed characteristic of the species, but are likely to vary between and within populations depending upon landscape structure and the history of movement rule evolution [@dyckHabitatFragmentationInsect1999; @hanskiVariationMigrationPropensity2004; @merckxLandscapeStructurePhenotypic2006; @fahrigNonoptimalAnimalMovement2007a; @ovaskainenTrackingButterflyMovements2008; @stevensMetaanalysisDispersalButterflies2010; @wangDispersalGlanvilleFritillary2011]. Dispersal kernels can vary through time [@schtickzelleTemporalVariationDispersal2012], and there can be considerable variability between individuals, sexes and stage classes [@delgadoEffectPhenotypicTraits2010; @turlureSpeciesSexspecificAdjustments; @bentonDispersalInvertebratesInfluences2012; @matthysenMulticausalityDispersalReview2012]."}``r if(dispersal_kernel_mixed){"

Particular emphasis has been placed during the last decade on rare long-distance dispersal events, which have been found fundamental for explaining phenomena such as rate of species’ range shifting in response to past and present climate change [@clarkReidParadoxRapid1998; @nathanSpreadNorthAmerican; @lesserContributionsLongdistanceDispersal2013] and connectivity of isolated populations [@johstMetapopulationPersistenceDynamic2002; @baguetteLongDistanceDispersal2003; @munozWindLongDistanceDispersal2004]. These events are difficult to capture and model with traditional kernels. Therefore, fat-tailed kernels and mixed kernels have started to be used [@bullockLongDistanceSeed2000; @clarkInvasionExtremesPopulation2001; @hovestadtAllInterpatchMovements2011; @fronhoferPickyHitchhikersVector2013a]."}`

`r if(dispersal_kernel){"Kernels are considered as ‘distance kernels’, i.e. the statistical distribution of the probability that an individual will move a certain distance [@hovestadtEvolutionEmergenceDispersal2012; @nathanDispersalKernelsReview2012]. These kernels are specifically used for the transfer phase, meaning that they do not incorporate information on the emigration or settlement probabilities, which are modelled independently. Therefore, dispersal kernels are applied only to dispersing individuals and not normally to the entire population.

There are many possible statistical distributions that have been fitted to dispersal data, which in many cases perform better than the negative exponential [@nathanDispersalKernelsReview2012]. However, the negative exponential is still commonly used, has been found useful for describing dispersal patterns of certain organisms."}``r if(dispersal_kernel_mixed){", and the combination of two different negative exponentials has been demonstrated to be a valuable method for discerning between common short-distance and rare long-distance dispersal [@hovestadtAllInterpatchMovements2011]. "}`

`r if(movement_model){"
It is increasingly acknowledged that individual movements within and between habitat patches, and consequently also population dynamics, are strongly affected by the behavioural and physical traits of individuals and by the landscape structure and composition [@moralesScalingAnimalMovements2002; @hawkesLinkingMovementBehaviour2009; @stevensLandscapeEffectsSpatial2012; @baguetteIndividualDispersalLandscape2013]. This has led to the development of mechanistic models where movement behaviour and its interaction with the environment is explicitly described [@nathanMovementEcologyParadigm2008a; @revillaIndividualMovementBehavior2008a; @moralesBuildingBridgeAnimal2010a; @palmerIntroducingStochasticMovement2011; @peerBreakingFunctionalConnectivity2011]. The classical method to represent individuals’ movements mechanistically is to use a random walk [@codlingRandomWalkModels2008], or its diffusion approximation, assuming that individuals are moving randomly in a homogeneous landscape and that they are all following the same rules. From this basis, there have been recent developments in diffusion models for including landscape heterogeneity and some behavioural responses, like reaction to habitat boundaries, directly derived from empirical data through state-space models [@ovaskainenBiasedMovementBoundary2003; @ovaskainenHabitatSpecificMovementParameters2004; @ovaskainenEmpiricalTestDiffusion2008; @pattersonStateSpaceModels2008; @zhengModellingDispersalDiffusion2009a; @ovaskainenModelingAnimalMovement2009]. Yet, these models do not account for individual variability or for many behavioural components including memory, perceptual range and movement modes. Despite this simplicity, diffusion models, and especially their recent developments, can still be satisfactory at large temporal and spatial scales and serve as a null hypothesis against which to test more complex movement models. Moreover they can provide basis for building blocks for population dynamics models.

Mechanistic IBMs allow extending the “random paradigm” by incorporating behavioural elements that are likely to be crucial in affecting species’ spatial dynamics [@limaBehavioralEcologyEcological1996; @baguetteLandscapeConnectivityAnimal2007; @knowltonUsingBehavioralLandscape2010; @shreeveLandscapeScaleConservation2011]. These elements can be assigned into six main categories: (i) the switching between different movement modes [for example foraging within the home range vs. dispersal [@fryxellMultipleMovementModes2008; @delattreDispersalMoodRevealed2010; @peerBreakingFunctionalConnectivity2011]]; (ii) the individuals’ perceptual range [@zollnerLandscapelevelPerceptualAbilities1997; @zollnerBehavioralTradeoffsWhen2005; @gardnerSimulatingDispersalReintroduced2004b; @oldenContextdependentPerceptualRanges2004; @vuilleumierAnimalDispersalModelling2006; @vuilleumierEffectsCognitiveAbilities2006; @peerIncorporatingPerceptualRange2008; @palmerIntroducingStochasticMovement2011]; (iii) the use of information in movement choices [@clobertInformedDispersalHeterogeneity2009] and the memory of previous experience [@smouseStochasticModellingAnimal2010]; (iv) the influence of habitat fragmentation and matrix heterogeneity on movement behaviours [@rickettsMatrixMattersEffective2001; @vandermeerMetapopulationDynamicsQuality2001; @schtickzelleBehaviouralResponsesHabitat2003; @revillaEffectsMatrixHeterogeneity2004; @wiegandEffectsHabitatLoss2005; @fahrigNonoptimalAnimalMovement2007a; @doverInfluencesLandscapeStructure2009]; (v) the individual responses to habitat boundaries [@schultzEdgeMediatedDispersalBehavior2001; @moralesBehaviorHabitatBoundaries2002; @merckxEvolutionMovementsBehaviour2003; @ovaskainenHabitatSpecificMovementParameters2004; @stevensQuantifyingFunctionalConnectivity2006; @peerBreakingFunctionalConnectivity2011]; and (vi) the period of activity [@revillaEffectsMatrixHeterogeneity2004] and the time scale of movements [@lambinHighConnectivityHigh2012].

A general framework for a mechanistic representation of movements has been outlined by Nathan et al. [-@nathanMovementEcologyParadigm2008a], who identified four basic components: the internal state of the individual (why does it move?), its motion capacities (how does it move?), its navigation capacities (when and where does it move?) and external factors that affect the movement. This framework allows us, starting from individual movements, and taking into account individual variability, to predict movement patterns over large temporal and spatial scales and potentially to scale up to populations, communities, ecosystems and to multi-generation / evolutionary processes [@holyoakTrendsMissingParts2008]. The ultimate limitation is likely to be the quantity and the type of data needed to parameterize this /these kind of models; therefore, the challenge is to understand which level of detail is needed to make reliable projections in different contexts and for different purposes [@limaBehavioralEcologyEcological1996; @moralesBuildingBridgeAnimal2010a].

Movement behaviours during the transfer phase are a core component of the dispersal strategy of an individual, and therefore they come under selection and they can evolve [@merckxEvolutionMovementsBehaviour2003; @fahrigNonoptimalAnimalMovement2007a; @hawkesLinkingMovementBehaviour2009; @travisModellingDispersalEcoevolutionary2012a]. Ultimately, it is the evolution of movement behaviours that leads to what we consider the evolution of dispersal kernels. A handful of theoretical studies have so far explored the evolution of movement rules. For example, it has been shown how the landscape composition and configuration, in interaction with the ecology of the species, can affect the evolution of movement patterns, such that the greater the costs of dispersal the more highly correlated are the emerging walks [@heinzAdaptivePatchSearching2006; @bartonEvolutionIntelligentDispersal2009]. Moreover, straighter movement paths [@phillipsLifehistoryEvolutionRangeshifting2010a] and riskier strategies seem to be selected during range expansion in such a way that the rate of expansion is maximized at the expense of the survival probability of the single individual [@bartonRiskyMovementIncreases2012]."}`

`r if(movement_SMS){"A Stochastic Movement Simulator (SMS, [@palmerIntroducingStochasticMovement2011]) is implemented. "}``r if(movement_corrRW){"A corelated random walk is implemented."}``r if(movement_model){"The submodel is fully individual-based and explicitly describes the movement behaviour of individuals with a level of detail, and hence parameters, which is probably close to the most parsimonious for a mechanistic movement model. However, it facilitates considerably increasing the complexity and realism with which the transfer phase is modelled."}`

See the submodel description for further details.

### Settlement

Settlement, or immigration, is the last phase of dispersal, when the organism stops in a new cell or patch of breeding habitat. This phase is determined by a suite of strategies, behaviours and reaction norms that lead individuals to the decision to stop in a particular place. Habitat selection, mate finding and density dependence are probably three of the main processes involved, but not the only ones. Like emigration, settlement is a complex process affected by multiple criteria including inter-individual variability and context dependencies. It can be influenced by the causes and mechanisms of the previous phases of dispersal [@clobertInformedDispersalHeterogeneity2009] and it has associated specific costs [@bonteCostsDispersal2012a], which can also feed back to the previous phases [@legalliardPatternsProcessesDispersal2012].

As for the previous phases, the use of different sources of abiotic and biotic information is likely to be crucial in the settlement decision, for which evidence is now accumulating. For example, studies have demonstrated that in some species, dispersing individuals exhibit a preference for habitat that is similar to the natal one, philopatry being a stronger predictor of habitat preferences for settlement than intrinsic habitat quality [@haughlandExplorationCorrelatesSettlement2004; @stampsEffectsNatalExperience2006; @stampsHowDifferentTypes2009]. Conspecific density and performance have also been demonstrated to be important cues for settlement decisions (conspecific attraction), because they can provide a rapid approximation of the habitat quality [@stampsConspecificAttractionAggregation1988; @doligezAvailabilityUsePublic2004; @fletcherSpeciesInteractionsPopulation2007; @verckenImportanceGoodNeighborhood2012; @clotucheSettlementDecisionsTwospotted2013].

From the theoretical point of view, much work has been conducted on habitat selection during settlement decisions and its consequences for species’ population dynamics and spatial genetic structure. The basic assumption is that individuals are expected to select habitat patches where their expected fitness is greater than the one expected in the natal patch, weighted by the costs of searching [@ruxtonFitnessDependentDispersal1998; @stampsHabitatSelectionDispersers2001; @bakerIncrementalCostsBenefits2004; @stampsSearchCostsHabitat2005; @armsworthStructureClinesFitness2008; @bonteCostsDispersal2012a]. Recently the idea of ‘matching habitat choice’ has been proposed, for which individuals aim to settle where the environment best matches with their phenotype. This process, expected to be more important for species with limited phenotypic plasticity, can have important implications for processes such as local adaptation, adaptive peak shifts and evolution of niche width, and speciation [@edelaarMatchingHabitatChoice2008]. Other factors affecting settlement such as density dependence [@poethkeAbilityIndividualsAssess2011], conspecific attraction (Fletcher 2006) or mate finding [@gilroyMateFindingOverlookedCritical2012], their evolution and their consequences on species’ responses to environmental changes, have been much less theoretically investigated.

This specific use case of RangeShifter incorporates some basic settlement rules. In any case, dispersing individuals are not allowed to settle in their natal `r if(cell_based){"cell"}``r if(patch_based){"patch"}`.

For more details, see the description of the submodel.

### Dispersal mortality

Dispersal is often a costly process for an organism [@bonteCostsDispersal2012a] and, in some cases, a dispersing individual may suffer mortality. Obtaining a sensible representation of dispersal requires that these mortality costs are described appropriately and, for this, it is important to recognize how dispersal mortality is incorporated in RangeShifter.
First, dispersal mortality can arise as a result of individuals failing to reach suitable habitat. `r if(dispersal_kernel){"For example, when individuals have no possibility to search for locally-suitable habitat, mortality occurs to all individuals that arrive in unsuitable habitat."}` `r if(movement_model){"Fo example, some individuals may fail to find suitable habitat before they use up a maximum number of movement steps. In this first case, dispersal mortality clearly depends upon the proportion of suitable habitat in the landscape and will increase as the availability of habitat declines."}`

`r if(dispersal_kernel){"A second source of dispersal mortality can be a constant or a density-dependent (i.e. individuals that travel further are more likely to die) probability of mortality. The latter may be thought to represent the increased energetic, time or attritional costs that longer-distance dispersers will experience [@bonteCostsDispersal2012a]."}`
`r if(movement_model){"A second source of dispersal mortality can be a per-step probability of mortality. This can be useful for representing mortality risks that increase with distance or time spent travelling."}``r if(movement_model & movement_cost){"Additionally, movement across a complex landscape is modeled more explicitly: the per-step mortality varies according to the nature of the local environment."}`

For more details, see the description of the submodel.

## Emergence

Species range distributions emerge from the population dynamics and the dispersal behaviour of the individuals.

## Adaptation

`r if(movement_SMS){"During the transfer process, individuals move according to what they can perceive of the landscape within their perceptual range $PR$. However, individuals do not know a priori their final destination. The $PR$ is defined by a number of cells. At each step, the individual evaluates the surrounding habitat in order to determine the effective cost of taking a particular step to each of the eight neighbouring cells. The effective cost is a mean of the cost of the neighbouring cell and the surrounding cells beyond it within the $PR$."}`

`r if(!movement_SMS){"Not applicable."}`

## Objectives

`r if (movement_SMS & goal_type==2){"The only goal of the dispersing individuals is to move away from the natal location. Individuals follow a straighter trajectory initially, and later become more tortuous and responsive to perceived landscape costs."}`
`r if (!movement_SMS & !goal_type==2){"Not applicable."}`

## Learning

Not applicable.

## Prediction

Not applicable.

## Sensing

`r if(mate_finding){"Individuals of both sexes need to be in the same cell in order to reproduce. Individuals in the same cell are aware of the sex of others."}`
`r if(movement_SMS){"Dispersing individuals can perceive the sourrounding landscape within their perceptual range $PR$."}`
`r if(cell_based & dispersal_kernel){ if(s@dispersal@Settlement@Settle>=2){"Dispersing individuals perceive the suitability of cells and might settle in a suitable neighbouring cell if the arrival cell is unsuitable."}}`
`r if(patch_based & dispersal_kernel){ if(s@dispersal@Settlement@Settle>=2){"Dispersing individuals perceive the suitability of patches and might settle in a suitable neighbouring patch if the arrival patch is unsuitable."}}`
`r if(cell_based & movement_model & settlement_densdep){"Dispersing individuals can perceive the density in cells and potentially decide to continue dispersing if the density is high."}`
`r if(patch_based & movement_model & settlement_densdep){"Dispersing individuals can perceive the density in patches and potentially decide to continue dispersing if the density is high."}`
`r if(!mate_finding & !movement_SMS){"Not applicable"}`


## Interaction

No interaction is considered in the model.

## Stochasticity

`r if(environmental_stochasticity){"Environmental stochasticity is considered in the model. "}else{"Not applicable. "}``r if(env_stoch_K & !stage_structured){"It acts on the capacity $K$."}``r if(env_stoch_R & !stage_structured){"It acts on the growth rate $r$."}``r if(env_stoch_K & stage_structured){"It acts on the strength of density dependence $1/b$."}``r if(env_stoch_R & stage_structured){"It acts on the fecundity $\\phi$."}`

Demographic stochasticity is explicitly included in all processes by default.


## Collectives

Not applicable

## Observation

`r if(output_range){"### Range 
The output _Sim0_Range.txt_ contains the following general information regarding the species' range: Replicate number, year, reproductive season within the year, total number of individuals"}``r if(output_range & stage_structured){", total number of individuals in each stage, total number of juveniles born"}``r if(output_range){", total number of "}``r if(output_range & cell_based){"cells"}``r if(output_range & patch_based){"patches"}``r if(output_range){" occupied by a population capable of breeding, ratio between occupied and suitable "}``r if(output_range & cell_based){"cells"}``r if(output_range & patch_based){"patches"}``r if(output_range){", species range in term of maximum and minimum coordinates of"}``r if(output_range & cell_based){" cells"}``r if(output_range & patch_based){" patches"}``r if(output_range){" occupied by breeding populations."}`

`r if(output_occ){"### Occupancy 
This output reports the "}``r if(output_occ & cell_based){"cell"}``r if(output_occ & patch_based){"patch"}``r if(output_occ){" probability of occupancy by a breeding population. This is only permissible for multiple replicates. Data will be recorded at the beginning of the year before any other process (and only once a year no matter the number of reproductive seasons per year). Two files will be produced: 1. _Sim0_Occupancy.txt_: This file contains a list of "}``r if(output_occ & cell_based){"all the cells in the landscape (x and y coordinates)"}``r if(output_occ & patch_based){"all the patches (PatchID)"}``r if(output_occ){". The remaining columns give the occupancy probability of the "}``r if(output_occ & cell_based){"cell"}``r if(output_occ & patch_based){"patch"}``r if(output_occ){" at defined time steps. The occupancy probability is obtained by dividing the number of times (replicates) that the "}``r if(output_occ & cell_based){"cell"}``r if(output_occ & patch_based){"patch"}``r if(output_occ){" has been occupied in a given year by the total number of replicates. 2. _Sim0_Occupancy_Stats.txt_: Summary occupancy statistics, i.e. the mean ratio between occupied and suitable cells (Mean_OccupSuit) and its standard error (Std_error) at the set time interval."}`

`r if(output_pop){"### Populations
The population output, _Sim0_Pop.txt_ contains statistics regarding each population present in the landscape at a given time interval. Data are collected before reproduction at each reproductive season at the specified yearly interval and at the end of the simulation. This output file contains the following information: Replicate number, year, reproductive season, "}``r if(output_pop & cell_based){"cell location"}``r if(output_pop & patch_based){"patch ID"}``r if(output_pop){", species number, number of individuals in the population"}``r if(output_pop & stage_structured & !sexual){", the number of individuals in each stage (NInd_stageX)"}``r if(output_pop & sexual & stage_structured){", the number of females (Nfemales_stageX) and of males (Nmales_stageX) in each stage"}``r if(output_pop & !stage_structured & sexual){", the number of females (Nfemales) and of males (Nmales) in the population"}``r if(output_pop & stage_structured & !sexual){", the number of juveniles born (NJuvs)"}``r if(output_pop & sexual){", the number of females juveniles (NJuvFemales) and males (NJuvMales)"}``r if(output_pop){"."}`

`r if(output_ind){"### Individuals 
This output, _Sim0_Rep0_Inds.txt_, contains information regarding each individual at a given time step. To avoid the production of huge files, a separate file is saved for each replicate (here assumed to be 0). "}``r if(output_ind & stage_structured){"Data are recorded after settlement and before aging, in order that dispersal data for individuals which die may be reported."}``r if(output_ind){" Individuals data for year $T$ therefore correspond to Population summary data for year $T+1$ (and individuals which die in year $T$ must be excluded for the data to match at population level). For each individual the following data are collected: Replicate number, year, reproductive season within the year, species number, individual ID, individuals status, natal cell and current "}``r if(output_ind & cell_based){"cell"}``r if(output_ind & patch_based){"patch"}``r if(output_ind){". If the individual has crossed an absorbing landscape or 'no-data' boundary, the current "}``r if(output_ind & cell_based){"cell"}``r if(output_ind & patch_based){"patch"}``r if(output_ind){" will be missing"}``r if(output_ind & sexual){", sex"}``r if(output_ind){", age"}``r if(output_ind & stage_structured){", stage"}``r if(output_ind){", distance moved in meters (linear distance from the centre of the starting cell to the centre of the arrival cell - DistMoved); if the individual has crossed an absorbing landscape or 'no-data' boundary, the distance moved will be missing (set to -1)"}``r if(output_ind & movement_model){", number of steps taken for movement models"}``r if(output_ind){"."}`

```{r eval=output_ind, echo=F, include=T}
if (cell_based){
  create.table <- data.frame("Status code" = c(0:9), "Description"=c(
  "Initial status in natal patch/philopatric recruit",
  "Disperser",
  "Disperser awaiting settlement in possible suitable cell",
  "Waiting between dispersal events",
  "Completed settlement",
  "Completed settlement in a suitable neighbouring cell",
  "Died during transfer by failing to find a suitable patch (includes exceeding the maximum number of steps or crossing an absorbing boundary)",
  "Died during transfer by constant, step-dependent, habitat-dependent or distance-dependent mortality",
  "Failed to survive annual (demographic) mortality",
  "Exceeded maximum age"
  ))
}
if (patch_based){
  create.table <- data.frame("Status code" = c(0:9), "Description"=c(
  "Initial status in natal patch/philopatric recruit",
  "Disperser",
  "Disperser awaiting settlement in possible suitable patch",
  "Waiting between dispersal events",
  "Completed settlement",
  "Completed settlement in a suitable neighbouring patch",
  "Died during transfer by failing to find a suitable patch \n (includes exceeding the maximum number of steps or crossing an absorbing boundary)",
  "Died during transfer by constant, step-dependent, habitat-dependent \n or distance-dependent mortality",
  "Failed to survive annual (demographic) mortality",
  "Exceeded maximum age"
  ))
}
knitr::kable(create.table, col.names = gsub("[.]", " ", names(create.table)), caption = 'Status codes of individuals', format.args = list(width=10))
```

`r if(output_conn){"### Connectivity
The connectivity matrix output, _Sim0_Connect.txt_, presents counts of the number of individuals successfully dispersing from each patch to each other patch for each year specified by the Connectivity Matrix every (years) box. If there is more than one reproductive season during the year, cumulative year-end totals are reported. Although the file contains the data required for true N x N matrices, the data are presented in list format (which can readily be converted to matrices by most analytical software): 1. Replicate number (Rep), 2. Year
3. ID number of natal patch (StartPatch), 4. ID number of settlement patch (EndPatch), 5. Number of individuals dispersing from StartPatch to EndPatch (NInds).
The rows having an entry of -999 are summary rows, showing the total number of successful emigrants from a patch (if EndPatch = -999) and the total number of successful immigrants into a patch (if StartPatch = -999). They are included to facilitate quick examination of the file without having to sum all the individual rows for a patch in any one year.
"}`

`r if(output_paths){"### SMS paths
Sim0_Rep0_SMSpaths.txt lists the cell-based trajectories of all (successfully or unsuccessfully) dispersed individuals from the natal to the final (settlement or fatal) patch for each year specified by OutIntPaths, starting from OutStartPaths. The data are presented in list format with the columns: Year, individual ID, consecutive step number, coordinates of cell at this step, status of individual. The status is an integer number that codes for the following possible states:    
0 = natal patch,    
1 = disperser,    
2 = disperser awaiting settlement in possible suitable patch,   
3 = waiting between dispersal events,    
4 = completed settlement,    
5 = completed settlement in a suitable neighbouring cell,    
6 = died during transfer by failing to find a suitable patch (includes exceeding maximum number of steps or crossing absorbing boundary),    
7 = died during transfer by constant, step-dependent, habitat-dependent or distance-dependent mortality,    
8 = failed to survive annual (demographic) mortality,    
9 = exceeded maximum age."}`

`r if(output_heatmaps){"### SMS Heat map 
OutputMaps/Sim0_Land0_Rep0_Visits.txt is a series of maps in ASCII raster format, showing how many times each cell has been visited by a dispersing individual across the whole time period of the simulation. These heat maps may be useful, for example, for identifying corridors which are heavily used during the dispersal phase. One raster map is created in the Output_Maps folder for each replicate simulation, and is in the same format as the input habitat file.
"}`

# Initialization

## Initialization of landscape

`r if(real_land & habitat_quality){"Landscapes are initialized according to the input raster maps. The density dependence of each cell is set as the respective fraction of the given maximum density dependence."}`
`r if(real_land & habitat_quality){"Landscapes are initialized according to the input raster maps. The density dependence of each cell is set according the given values for each habitat type."}`
`r if(arti_land){"An artificial landscape is generated according to the given parameters (see submodule description). "}``r if(arti_land & arti_land_continuous){"Each cell is given a continuous value between 0 and 1, which describes the percentage of habitat cover or habitat quality. within a cell. The effective density dependence of that cell is calculated as the respective fraction of the given maximum density dependence."}``r if(arti_land & !arti_land_continuous){"The resulting landscape is binary, with the two values Habitat and Matrix (i.e. Non-habitat)."}`



## Initialization of populations

`r if(s@init@InitType==0 & s@init@FreeType==0 & cell_based){cat("Populations are initialized randomly in ", s@init@NrCells, " cells according to the habitat map.")}`
`r if(s@init@InitType==0 & s@init@FreeType==0 & patch_based){cat("Populations are initialized randomly in ", s@init@NrCells, " patches according to the habitat map.")}`
`r if(s@init@InitType==0 & s@init@FreeType==1 & cell_based){"Populations are initialized randomly in all suitable cells according to the habitat map."}`
`r if(s@init@InitType==0 & s@init@FreeType==1 & patch_based){"Populations are initialized randomly in all suitable patches according to the habitat map."}`
`r if(s@init@InitType==1 & s@init@SpType==0){"Initial populations are loaded from a species distribution map in all suitable cells within all distribution presence cells."}`
`r if(s@init@InitType==1 & s@init@SpType==1){cat("Initial populations are loaded from a species distribution map in ",s@init@NrCells ," randomly chosen presence cells.")}`
`r if(s@init@InitType==2 ){"Populations are initialized from a file listing the initial individuals (of given"}``r if(s@init@InitType==2  & sexual & stage_structured){" sex, age and stage"}``r if(s@init@InitType==2  & !sexual & stage_structured){" age and stage"}``r if(s@init@InitType==2  & !sexual & !stage_structured){" age"}``r if(s@init@InitType==2 & cell_based){" in specified cells. This option allows simulation of a reintroduction scenario."}``r if(s@init@InitType==2 & patch_based){" in specified patches. This option allows simulation of a reintroduction scenario."}` `r if(s@init@InitDens==2 & patch_based){cat(s@init@IndsHaCell, " number of individuals per hectare are seeded in each patch.")}` `r if(s@init@InitDens==2 & cell_based){cat(s@init@IndsHaCell, " number of individuals per hectare are seeded in each cell.")}` `r if(s@init@InitDens==0 & patch_based & !stage_structured){"The number of seeded individuals per hectare in each patch is determined by $K$."}``r if(s@init@InitDens==0 & patch_based & stage_structured){"The number of seeded individuals per hectare in each patch is determined by $1/b$."}``r if(s@init@InitDens==0 & cell_based & !stage_structured){"The number of seeded individuals per hectare in each cell is determined by $K$."}``r if(s@init@InitDens==0 & cell_based & stage_structured){"The number of seeded individuals per hectare in each cell is determined by $1/b$."}``r if(s@init@InitDens==1 & patch_based & !stage_structured){"The number of seeded individuals per hectare in each patch is determined by half of $K$."}``r if(s@init@InitDens==1 & patch_based & stage_structured){"The number of seeded individuals per hectare in each patch is determined by half of $1/b$."}``r if(s@init@InitDens==1 & cell_based & !stage_structured){"The number of seeded individuals per hectare in each cell is determined by half of $K$."}``r if(s@init@InitDens==1 & cell_based & stage_structured){"The number of seeded individuals per hectare in each cell is determined by half of $1/b$."}`

`r if(stage_structured & s@init@InitType!=2 & s@init@InitAge==0){"The proportion of individuals that is initialised at each stage class is set via a numeric vector $PropStages$. It has as many entries as number of stages, starting from the juvenile stage (0). The age is set as the minimal age of the respective stage."}`
`r if(stage_structured & s@init@InitType!=2 & s@init@InitAge==1){"The proportion of individuals that is initialised at each stage class is set via a numeric vector $PropStages$. It has as many entries as number of stages, starting from the juvenile stage (0). The age is set randomly between the minimal and maximal age of the respective stage."}`
`r if(stage_structured & s@init@InitType!=2 & s@init@InitAge==2){"The proportion of individuals that is initialised at each stage class is set via a numeric vector $PropStages$. It has as many entries as number of stages, starting from the juvenile stage (0). The age is set approximately in accordance with the number of years taken to pass through the stage and the survival rate of the respective stage."}`

`r if(stage_structured & s@init@InitType==2){"The proportion of individuals that is initialised at each stage class and the age distributions are loaded via the file listing the initial individuals."}`

`r if(s@init@minX>0 | s@init@maxX>0 | s@init@minY>0 | s@init@maxY>0 | s@init@InitFreezeYear>0 | s@init@RestrictFreq>0 | s@init@RestrictRows>0 | s@init@FinalFreezeYear>0){"$\\color{red}{\\text{These options were not yet integrated in the ODD template.}}$ $\\color{red}{\\text{Please include the discribtion on your own.}}$"} `

# Input data

The model requires the following input data:

`r if(real_land & habitat_quality & !dynamic_landscape){"* The underlying landscape raster map as a text file in ESRI ASCII raster format. The  grid needs to contain values for each cell, one line per row. Each cell in the landscape is assigned a continuous percentage value between 0.0 and 100.0 (of the maximum density dependence "}``r if(real_land & habitat_quality & !dynamic_landscape & stage_structured){"$1/b$"}``r if(real_land & habitat_quality & !dynamic_landscape & !stage_structured){"$K$"}``r if(real_land & habitat_quality & !dynamic_landscape){". There are no explicit habitat or land-cover types. This allows integrating different methods for calculating the habitat suitability for a given species. For example, qualities can result from different methods of suitability modelling, which incorporate multiple variables like habitat types, elevation, climate, etc. In the current version of the program, a straight-line relationship between the habitat quality and the actual density-dependence of the population dynamics is assumed. Therefore, the quality should be scaled accordingly in case of a curvilinear relationship.    "}`

`r if(real_land & habitat_type & !dynamic_landscape){"* The underlying landscape raster map as a text file in ESRI ASCII raster format. The  grid needs to contain values for each cell, one line per row. Each habitat or land-cover type has a unique integer code. Each cell in the file contains a single habitat code and 100 percent coverage is assumed for the cell. The landscape is therefore composed of discrete habitat cells. The codes are required to be sequential integers starting from 1 and ranging to Nhabitats.    "}`

`r if(real_land & habitat_quality & dynamic_landscape){"* (A vector of) All underlying landscape raster maps as a text files in ESRI ASCII raster format. The  grids need to contain values for each cell, one line per row. Each cell in the landscapes is assigned a continuous percentage value between 0.0 and 100.0 (of the maximum density dependence "}``r if(real_land & habitat_quality & dynamic_landscape & stage_structured){"$1/b$"}``r if(real_land & habitat_quality & dynamic_landscape & !stage_structured){"$K$"}``r if(real_land & habitat_quality & dynamic_landscape){". There are no explicit habitat or land-cover types. This allows integrating different methods for calculating the habitat suitability for a given species. For example, qualities can result from different methods of suitability modelling, which incorporate multiple variables like habitat types, elevation, climate, etc. In the current version of the program, a straight-line relationship between the habitat quality and the actual density-dependence of the population dynamics is assumed. Therefore, the quality should be scaled accordingly in case of a curvilinear relationship. Any part of the original landscape which was a ‘no-data’ region (e.g. the sea or land beyond a study area boundary) must remain in that state for the whole simulation.     "}`

`r if(real_land & habitat_type & dynamic_landscape){"* (A vector of) All underlying landscape raster maps as a text file in ESRI ASCII raster format. The  grids need to contain values for each cell, one line per row. Each habitat or land-cover type has a unique integer code. Each cell in the files contains a single habitat code and 100 percent coverage is assumed for the cell. The landscapes are therefore composed of discrete habitat cells. The codes are required to be sequential integers starting from 1 and ranging to Nhabitats. Any part of the original landscape which was a ‘no-data’ region (e.g. the sea or land beyond a study area boundary) must remain in that state for the whole simulation.     "}`

`r if(patch_based & real_land & !dynamic_landscape){"* A raster map  as a text file in ESRI ASCII raster format of the same landscape, where each cell contains the ID number of the patch to which it belongs. Each patch must have a unique positive integer ID. The ID of every cell that does not belong to a patch (i.e. non-habitat/matrix) must be zero. Note that a single patch is the unit at which the density dependence in the population dynamics acts. Therefore, a patch can be discontinuous, i.e. it can contain cells that do not belong to the patch if they are assumed not to affect the dynamics, or on the other hand, patch cells that are not physically contiguous to the rest of the patch cells.    "}`

`r if(patch_based & real_land & dynamic_landscape){"* Raster maps  as text files in ESRI ASCII raster format of the same landscapes, where each cell contains the ID number of the patch to which it belongs. Each patch must have a unique positive integer ID. The ID of every cell that does not belong to a patch (i.e. non-habitat/matrix) must be zero. Note that a single patch is the unit at which the density dependence in the population dynamics acts. Therefore, a patch can be discontinuous, i.e. it can contain cells that do not belong to the patch if they are assumed not to affect the dynamics, or on the other hand, patch cells that are not physically contiguous to the rest of the patch cells. The identity of patches is not cross-checked between changes, and care must therefore be taken to ensure consistency; otherwise, a patch (and its resident population) can jump to a distant location or be split into two or more disjunct parts, with unpredictable and possibly weird consequences. It is legitimate for a patch to be split into two or more separate patches (e.g. by construction of a motorway or some other barrier), but any existing population will remain with the part (if any) which retains the original patch number, and populations within the other parts (having a new patch number) must arise through colonisation. Possible ways to work around this restriction include:

  * Assign to all post-change parts of the original patch a new, unique patch number and specify that dispersal is allowed after population destruction (which is possible only for a structured population), in which case some colonisation of the new patches should occur. Note that the connectivity matrix will be misleading in such cases, as every successful ‘disperser’ will appear to have moved from patch N to patch M (where M is the new patch number).    

  * Instead of a single original patch, define two (or more) distinct but adjacent patches in the original landscape, so that they each retain their own populations when they become separated by the landscape change.    "}`
  
`r if(real_land & !dynamic_landscape & movement_cost_file){"* A raster map  as a text file in ESRI ASCII raster format containing the SMS costs. The specified map has to match the landscape raster in extent, coordinates and resolution, and each cell contains a cost value, with the minimal possible cost being 1.   "}`

`r if(real_land & dynamic_landscape & movement_cost_file){"* Raster maps  as text files in ESRI ASCII raster format containing the SMS costs. The specified maps have to match the landscape rasters in extent, coordinates and resolution, and each cell contains a cost value, with the minimal possible cost being 1.   "}`

`r if(real_land & s@init@InitType==1 & s@init@SpType==0){"* A species distribution map as a text file in ESRI ASCII raster format containing the initial destribution. It must be aligned with the landscape map,  i.e. the coordinates of the lower-left corner must be the same. The extent of the map does not have to be necessarily the same as the landscape. The resolution can be the same or coarser, provided that it is a multiple of the landscape resolution. For example, if the landscape cell size is 250m, the species distribution can be at the resolution of 250m, 500m, 750m, 1000m etc. Each cell of the species distribution map must contain either 0 (species absent or not recorded) or 1 (species present).    "}`

`r if(s@init@InitType==2){"* An initial individuals list file. The population is initialised according to a list of specific individuals (of given sex, age and stage, if appropriate) in specified cells/patches. This option allows simulation of a reintroduction scenario. It must be a tab-separated list with explicit column headers and one row for each individual to be initialized. The expected column headers must match the following order exactly: 'Year', 'Species' (must = 0), "}``r if(s@init@InitType==2 & cell_based){"'X', 'Y', "}``r if(s@init@InitType==2 & patch_based){"'PatchID', "}``r if(s@init@InitType==2){"'Ninds', "}``r if(s@init@InitType==2 & sexual){"'Sex', 'Age'"}``r if(s@init@InitType==2 & stage_structured){"', Stage'"}``r if(s@init@InitType==2){"."}``r if(s@init@InitType==2 & sexual){" The sex is specified with 0 for female and 1 for male."}`

# Submodels

`r if(arti_land){"## Landscape

To generate a fractal landscape, the midpoint displacement algorithm [@saupeAlgorithmsRandomFractals1988] is applied, adapted to allow for the generation of elongated landscapes (useful for theoretical studies on range shifting and environmental gradients). Landscape structure is determined by two parameters: the proportion of landscape occupied by suitable habitat $p$ and the degree of spatial autocorrelation (Hurst exponent, $H$) which ranges from > 0.0 (low autocorrelation but still not completely spatially independent) to < 1.0 (high autocorrelation, i.e. high habitat aggregation). 
The resulting landscape is"}``r if(arti_land & arti_land_continuous){"continuous. It describes the percentage of habitat cover or habitat quality within a cell. The effective "}``r if(arti_land & arti_land_continuous & stage_structured){" demographic density dependence $1/b$ "}``r if(arti_land & arti_land_continuous & !stage_structured){" limiting carrying capacity $K$ "}``r if(arti_land & arti_land_continuous){" of that cell is calculated as the respective fraction of the value of "}``r if(arti_land & arti_land_continuous & stage_structured){" the demographic density dependence $1/b$."}``r if(arti_land & arti_land_continuous & !stage_structured){" the limiting carrying capacity $K$."}``r if(arti_land & !arti_land_continuous){"binary, either being habitat or matrix (i.e. non-habitat)."}`

`r if(real_land & !dynamic_landscape){"## Landscape

A real landscape is imported consisting of"}` `r if(real_land & habitat_quality & !dynamic_landscape){" continuous values, ranging from 0.0 to 100.0, that represent percentages of habitat cover or quality."}``r if(real_land & habitat_type & !dynamic_landscape){" unique integer habitat codes to characterise the habitat type of each cell. "}``r if(real_land & patch_based & !dynamic_landscape){"An additional file of the same landscape is provided, where each cell contains the ID number of the patch to which it belongs. Each patch has a unique positive integer ID. The ID of every cell that does not belong to a patch (i.e. non-habitat/matrix) must be zero. Note that a single patch is the unit at which the density dependence in the population dynamics acts. Therefore, a patch can be discontinuous, i.e. it can contain cells that do not belong to the patch if they are assumed not to affect the dynamics, or on the other hand, patch cells that are not physically contiguous to the rest of the patch cells."}`
`r if(dynamic_landscape){"## Landscape

Dynamic landscapes are imported consisting of"}` `r if(dynamic_landscape & real_land & habitat_quality){" continuous values, ranging from 0.0 to 100.0, that represent percentages of habitat cover or quality."}``r if(dynamic_landscape & real_land & habitat_type){" unique integer habitat codes to characterise the habitat type of each cell. The attributes of cells change at specified years during the course of a simulation. Any landscape change occurs at the start of the year, i.e. before the  reproductive season."}`
`r if(dynamic_landscape & real_land & patch_based){"Additional files of the same landscapes are provided, where each cell contains the ID number of the patch to which it belongs. Each patch has a unique positive integer ID. The ID of every cell that does not belong to a patch (i.e. non-habitat/matrix) must be zero. Note that a single patch is the unit at which the density dependence in the population dynamics acts. Therefore, a patch can be discontinuous, i.e. it can contain cells that do not belong to the patch if they are assumed not to affect the dynamics, or on the other hand, patch cells that are not physically contiguous to the rest of the patch cells. As the landscape is dynamic, the shape of patches may change, patches may be removed and new patches may be created where there was previously inter-patch matrix. 
"}``r if(dynamic_landscape){"Thus some populations may be extirpated "}``r if(dynamic_landscape & !stage_structured){"(all individuals die)"}``r if(dynamic_landscape & stage_structured){"(all individuals either die or have an immediate opportunity to disperse)"}``r if(dynamic_landscape){", and new populations may arise from colonisation of newly suitable areas. "}``r if(dynamic_landscape & movement_cost_file){"In addition, the cost map for the movement processes is dynamic."}`

`r if(real_land & !stage_structured){"In addition, the limiting carrying capacity $K$ is given in units of the number of individuals per hectare. "}``r if(real_land & stage_structured){"In addition, the demographic density dependence $1/b$ is given in units of the number of individuals per hectare. "}``r if(real_land & habitat_type){"A vector of the length of the habitat types specifies the respective density dependence for every habitat code."}``r if(real_land & habitat_quality){"
The given density dependence is interpreted as the maximum density reached in cells with 100% habitat. All other cells hold the respective fraction of the density dependence."}`

`r if(environmental_stochasticity){"## Environmental stochasticity

In RangeShifter, environmental stochasticity is implemented using a first order autoregressive process to generate time series of the noise value $\\epsilon$  [@ruokolainenEcologicalEvolutionaryDynamics2009]: 

$$\\epsilon_{t+1} = \\kappa \\epsilon_{t} + \\omega_{t} \\sqrt{1−\\kappa^2}$$

where $\\kappa$ is the autocorrelation coefficient and $\\omega$ is a random normal variable drawn from $N(0,\\sigma)$."}``r if(environmental_stochasticity & s@simul@ac==0){" In this specific use case auto correlation is switched of ($\\kappa$ = 0) and only red noise is considered."}``r if(environmental_stochasticity){"Changing $\\omega$ changes the amplitude of the fluctuations. The spatial scale of the variation is"}``r if(environmental_stochasticity & !env_stoch_loc){" global (a single time series for the entire landscape)"}``r if(environmental_stochasticity & env_stoch_loc){" local (each cell fluctuates independently)"}``r if(environmental_stochasticity){", and is always applied on a yearly basis. Different degrees of spatial autocorrelation are not implemented in the current version."}`

`r if(environmental_stochasticity & env_stoch_K & !stage_structured){"The noise affects the species’ demographic density-dependence $K$ through the following equation: 
$$K_{x,y,t} = K_{x,y,0} + K*\\epsilon_{t}$$
where $x$ and $y$ are the cell coordinates and $K$ is the local carrying capacity in absence of stochasticity. In the absence of an environmental gradient, $K_{x,y,0}$ is equal to $K$."}`

`r if(environmental_stochasticity & env_stoch_K & stage_structured){"The noise affects the species’ demographic density-dependence $1/b$ through the following equation: 
$${1/b}0_{x,y,t} = {1/b}_{x,y,0} + {1/b}*\\epsilon_{t}$$
where $x$ and $y$ are the cell coordinates and $1/b$ is the nature of demographic density-dependence) in absence of stochasticity. In the absence of an environmental gradient, $1/b_{x,y,0}$ is equal to $1/b$."}`

`r if(environmental_stochasticity & env_stoch_R & !stage_structured){"The noise affects the species’ growth rate $R$ through the following equation: 
$$R_{x,y,t} = R_{x,y,0} + R*\\epsilon_{t}$$
where $x$ and $y$ are the cell coordinates and $R$ is the growth rate in absence of stochasticity. In the absence of an environmental gradient, $R_{x,y,0}$ is equal to $R$."}`

`r if(environmental_stochasticity & env_stoch_R & stage_structured){"The noise affects the species’ fecundity $\\phi$ through the following equation: 

$$\\phi_{x,y,t} = \\phi_{x,y,0} + \\phi*\\epsilon_{t}$$

where $x$ and $y$ are the cell coordinates and $\\phi$ is the fecundity in absence of stochasticity. In the absence of an environmental gradient, $\\phi_{x,y,0}$ is equal to $\\phi$."}`

## Reproduction
`r if(stage_structured){"At the beginning of each year, reproduction is the first process to be modelled. "}`The model simulates `r if(rep_seasons==1){"1 reproductive season"} else{cat(rep_seasons, "reproductive seasons")}` per year. `r if(stage_structured & survival_schedule==0){"Survival and development of all the stages (apart from stage 0) occur simultaneously with reproduction, followed by dispersal and finally survival and development of stage 0. Individuals age at the end of each year."}` `r if(stage_structured & survival_schedule==1){"Reproduction is followed by dispersal. After each reproductive season, survival and successive development of all the stages are modelled (between reproductive seasons). Aging occurs at the end of the year."}` `r if(stage_structured & survival_schedule==2){"Reproduction is followed by dispersal after each reproductive event. Survival and development of all stages happen only at the end of all reproductive seasons (annually), followed by aging at the end of the year."}`
`r if(!stage_structured){"At each generation the life cycle comprises: reproduction, death of the adults and offspring dispersal (in that order)."}`
`r if(!stage_structured & !sexual & cell_based){"Recruitment is determined by a stochastic, individual-based formulation of Maynard-Smith and Slatkin’s [-@smithStabilityPredatorPreySystems1973] population model, where the number of offspring produced by a single individual in the cell $i$ at time $t$, is drawn from the following distribution:

$$Poisson(\\dfrac{R_{i,t}}{{1+|R_{i,t}-1|*\\dfrac{N_{i,t}}{K_{i,t}}^{b_{c}}}})$$

Here, $R_{i,t}$ is the maximum growth rate (obtained at very low density only) and $K_{i,t}$ is the carrying capacity."}`
`r if(!stage_structured & !sexual & patch_based){"Recruitment is determined by a stochastic, individual-based formulation of Maynard-Smith and Slatkin’s [-@smithStabilityPredatorPreySystems1973] population model, where the number of offspring produced by a single individual in the patch $i$ at time t, is drawn from the following distribution:

$$Poisson(\\dfrac{R_{i,t}}{{1+|R_{i,t}-1|*\\dfrac{N_{i,t}}{K_{i,t}}^{b_{c}}}})$$

Here, $R_{i,t}$ is the maximum growth rate (obtained at very low density only) and $K_{i,t}$ is the carrying capacity."}`
`r if(!stage_structured & !sexual & (dynamic_landscape | environmental_stochasticity) ){"$R_{i}$ and $K_{i,t}$ vary in space and time."}`
`r if(!stage_structured & !sexual){"$b_{c}$ is the competition coefficient which describes the type of density regulation, providing for under-compensatory ($b_{c}$ < 1), compensatory ($b_{c}$ = 1) or over-compensatory ($b_{c}$ > 1) dynamics."}`

`r if(!stage_structured & sexual){"Individuals are explicitly characterized by their sex. The proportion of each sex in the population is controlled by setting the proportion of males (this is interpreted as the probability that an individual is male; hence a skewed sex-ratio at birth (or initialisation) may occur in a small population)."}`
`r if(!stage_structured & sexual & mating_simple){"Each female individual is assumed to mate, as long as there is at least one male in the population. The Maynard Smith and Slatkin model is used to determine the expected number of offspring produced by each female.$R_{i,t}$ is multiplied by 2 to maintain equivalence compared to the standard equation [@lindstromSexualReproductionPopulation1998]:

$$Poisson(\\dfrac{(2*R_{i,t})}{{1+|R_{i,t}-1|*\\dfrac{N_{i,t}}{K_{i,t}}^{b_{c}}}})$$"}`
`r if(!stage_structured & sexual & mating_complex){"The mating system is explicitly modelled through a mating function [@lindstromSexualReproductionPopulation1998; @legendreAgeStructureMating2004; @gomesDiscreteTwosexModels2010], where the number of mated females $c$ is given by:

$$c = min(1,2hm/f+hm)f$$

where $f$ and $m$ are the numbers of potentially reproductive females and males, respectively, and $h$ is the maximum harem size, i.e. the maximum number of pair bonds that a male can establish. $h$ = 1 corresponds to monogamy, 0 < $h$ < 1 to polyandry and $h$ > 1 to polygyny.
Each potentially reproductive female has a probability of reproducing pr given by:

$p_{r}=\\dfrac{c}{f}$

A Bernoulli trial, $Bern(p_{r})$, determines if the female reproduces or not. Hence, the specification of the mating system determines the probability for each female to reproduce. However, no explicit pair bonds are formed. For females that reproduce, the number of offspring is determined through 

$$Poisson(\\dfrac{(2*R_{i,t})}{{1+|R_{i,t}-1|*\\dfrac{N_{i,t}}{K_{i,t}}^{b_{c}}}})$$"}`

`r if(stage_structured){"Generations overlap and individuals are classified in different stages (e.g. immature vs. breeding individuals) differing in their demographic parameters. Individuals are characterized by their age and stage. Each stage has a certain fecundity $\\phi$, survival $\\sigma$ and probability of developing to the next stage $\\gamma$. The parameters are provided through classical transition matrices [@caswellMatrixPopulationModels2001a]. However, these are not solved analytically as is typical for matrix models but, instead, the parameters are applied stochastically in an individual-based fashion.
At each reproductive season, two parameters control the likelihood that each individual / female reproduces:    

* First, it is determined whether a reproductively mature female is a potential reproducer."}``r if(stage_structured & rep_interval>0){cat("A female, which has already reproduced,  has to wait", rep_interval," reproductive seasons to be able to reproduce again. Only those mature females that are either yet to reproduce, or last reproduced more than this number of reproductive seasons previously, are potential breeders.    ")}``r if(stage_structured & rep_interval==0){"Only those mature females that are able to reproduce, are potential breeders.    "}`     
`r if(stage_structured){"

* Potential breeders all reproduce with set probability $\\phi$.    
"}`    

`r if(stage_structured & !sexual){"In this specific use case, an asexual/only-female model was implemented. To avoid the problem of offspring developing to the next stage in the same year without losing the offspring stage, and hence the chance for simulating post-natal dispersal, an explicit juvenile stage (stage 0) is added:

$$A = \\begin{pmatrix} 0 & 0 & \\phi \\\\
1.0 & \\sigma(1-\\gamma) & 0 \\\\
0 & \\sigma\\gamma & \\sigma
\\end{pmatrix}$$

Juveniles have to develop to stage 1 in the same year they are born. It is important to note that juvenile mortality can be accounted for in two ways. Either it is included in adult fecundity $\\phi$ (by appropriately reducing its value), and $\\sigma_{0}\\gamma_{0-1}$ is equal to 1.0. This is how it is typically accounted for in matrix models. Or, alternatively, $\\phi$ is equal to the true maximum fecundity and $\\sigma_{0}\\gamma_{0-1}$ is less than 1.0. Only the first approach allows straightforward direct comparison with standard analytical matrix models.
The parameters in the matrix are used in a stochastic way at the individual level. Each individual/female at stage $s$, if it reproduces, produces a number of offspring given by Poisson($\\phi_{s}$). "}`

`r if(stage_structured & sexual & !demography_sexdep){"To avoid the problem of offspring developing to the next stage in the same year without losing the offspring stage, and hence the chance for simulating post-natal dispersal, we added an explicit juvenile stage (stage 0):

$$A = \\begin{pmatrix} 0 & 0 & \\phi \\\\
1.0 & \\sigma(1-\\gamma) & 0 \\\\
0 & \\sigma\\gamma & \\sigma
\\end{pmatrix}$$

Juveniles have to develop to stage 1 in the same year they are born. It is important to note that juvenile mortality can be accounted for in two ways. Either it is included in adult fecundity $\\phi$ (by appropriately reducing its value), and $\\sigma_{0}\\gamma_{0-1}$ is equal to 1.0. This is how it is typically accounted for in matrix models. Or, alternatively, $\\phi$ is equal to the true maximum fecundity and $\\sigma_{0}\\gamma_{0-1}$ is less than 1.0. Only the first approach allows straightforward direct comparison with standard analytical matrix models.
The parameters in the matrix are used in a stochastic way at the individual level. Individuals are defined by their sex and the sex is acknowledged also in the dispersal process. $\\phi$ refers to the number of offspring (males and females) per female. Each female at stage $s$, if it reproduces, produces a number of offspring given by Poisson($\\phi_{s}$). "}`

`r if(stage_structured & sexual & demography_sexdep){"The mating system is explicitly modelled. The mating system is explicitly modelled through a mating function [@lindstromSexualReproductionPopulation1998; @legendreAgeStructureMating2004; @gomesDiscreteTwosexModels2010], where the number of mated females $c$ is given by:

$$c = min(1,2hm/f+hm)f$$

where $f$ and $m$ are the numbers of potentially reproductive females and males, respectively, and $h$ is the maximum harem size, i.e. the maximum number of pair bonds that a male can establish. $h$ = 1 corresponds to monogamy, 0 < $h$ < 1 to polyandry and $h$ > 1 to polygyny.
Each potentially reproductive female has a probability of reproducing $pr$ given by:

$$p_{r}=\\dfrac{c}{f}$$

A Bernoulli trial, $Bern(p_{r})$, determines if the female reproduces or not. Hence, the specification of the mating system determines the probability for each female to reproduce. However, no explicit pair bonds are formed. 
Additionally, the demographic parameters are sex-dependent.
$\\gamma_{m}$ and $\\gamma_{f}$ are the probability of developing from stage 1 to stage 2 of males and females
respectively, $\\sigma_{1m}$, $\\sigma_{1f}$, $\\sigma_{2m}$ and $\\sigma_{2f}$ are the two sexes’ survival probabilities at each stage and
$\\phi_{m}$ and $\\phi_{f}$ are their fecundities. In the classical matrix modelling framework, $\\phi_{m}$ and $\\phi_{f}$ are
derived from a birth function, which takes into account the number of males and females,
the harem size and the clutch size [@caswellTwoSexModelsChaos1986; @caswellMatrixPopulationModels2001a]. In RangeShifter, the mating and the birth processes are modelled explicitly and separately in an individual-based
manner; therefore, the fecundity parameter utilized is the same as in the non sexspecific
model, as the differences between sexes are already accounted for during the mating
process (i.e. number of offspring per female). What the user still needs to determine before
running structured explicit mating system models in RangeShifter is at which stages males
are reproductive.
To avoid the problem of offspring developing to the next stage in the same year without losing the offspring stage, and hence the chance for simulating post-natal dispersal, an explicit juvenile stage (stage 0) is added:

$$A = \\begin{pmatrix} 0 & 0 & 0 & 0 & \\phi_{m} & \\phi_{f}\\\\
1.0 & 0 & \\sigma_{1m}(1-\\gamma_{m}) & 0 & 0 & 0\\\\
0 & 1.0 & 0 & \\sigma_{1f}(1-\\gamma_{f}) & 0 & 0\\\\
0 & 0 & \\sigma_{1m}\\gamma_{m} & 0 & \\sigma_{2m} & 0\\\\
0 & 0 & 0 & \\sigma_{1f}\\gamma_{f} & 0 & \\sigma_{2f}
\\end{pmatrix}$$"}`

`r if(stage_structured & repro_densdep & !repro_stagedep){"Reproduction is density-dependent. Following Neubert & Caswell [-@neubertDensitydependentVitalRates2000], density
dependence in fecundity is implemented as an exponential decay:
$$\\phi_{i} = \\phi_{0,i}*e^{-bN_{t}}$$
where $\\phi_{i}$ is the fecundity of stage $i$, $\\phi_{0,i}$ is its maximum fecundity at low densities, $b$ is the
strength of density dependence and $N_{t}$ is the total number of individuals in the local
population at time $t$."}`

`r if(stage_structured & repro_densdep & repro_stagedep){"Reproduction is density- and stage-dependent. Following Neubert & Caswell [-@neubertDensitydependentVitalRates2000], density and stage
dependence in fecundity is implemented as an exponential decay:

$$\\phi_{i} = \\phi_{0,i}*e^{-b\\sum_{j = 1}^{S} \\omega_{ij}N_{j,t}}$$

where $\\phi_{i}$ is the fecundity of stage $i$, $\\phi_{0,i}$ is its maximum fecundity at low densities, $b$ is the
strength of density dependence, $S$ indicates the number of stages and $\\omega_{ij}$ is contribution of stage $j$ to the density dependence in the fecundity of stage $i$ and $N_{j,t}$ the number of individuals in stage $j$ at time $t$ (e.g. [@caswellSensitivityAnalysisEquilibrium2004])."}`

## Survival `r if(stage_structured){"& Development"}` 
`r if(stage_structured & survival_schedule==0){"Survival and development of all the stages (apart from stage 0) occur simultaneously with reproduction, followed by dispersal and finally survival and development of stage 0."}` 
`r if(stage_structured & survival_schedule==1){"Reproduction is first followed by dispersal. Only then survival and successive development of all the stages are modelled."}` 
`r if(stage_structured & survival_schedule==2){"Reproduction is first followed by dispersal after each reproductive event. Survival and development of all stages happen only at the end of all reproductive seasons."}`

`r if(!stage_structured & !local_ext_prob){"In this specific use case, survival is not explicitly modelled."}`
`r if(stage_structured & !survival_densdep & !survival_stagedep){"In this specific use case, survival is neither density nor stage dependent. Bernoulli trials $Bern(\\sigma)$ determine if an individual survives or not."}`
`r if(stage_structured & !survival_densdep & survival_stagedep){"In this specific use case, survival is stage dependent. Bernoulli trials $Bern(\\sigma_{s})$ determine if an individual survives or not. "}`

`r if(stage_structured & survival_densdep & !survival_stagedep){"In this specific use case, survival is density dependent. Density dependence in survival is implemented as an exponential decay:

$$\\sigma_{i} = \\sigma_{0,i}*e^{-C_{\\sigma}bN_{t}}$$

where $\\sigma_{i}$ is the survival probability of stage $i$, $\\sigma_{0,i}$ is its survival probability at low densities, $b$ is the strength of density dependence and $N_{t}$ is the total number of individuals in the local population at time $t$. To allow for the possibility of having different strengths of density dependence in different processes, we introduce the coefficient $C_{\\sigma}$, which scales the strength of density dependence in survival relative to the strength of density dependence $b$ in fecundity.
Bernoulli trials $Bern(\\sigma_{i})$ determine if an individual develops to the next stage or not.
"}`

`r if(stage_structured & survival_densdep & survival_stagedep){"In this specific use case, survival is density dependent. Density and stage dependence in survival is implemented as an exponential decay:

$$\\sigma_{i} = \\sigma_{0,i}*e^{-C_{\\sigma}b\\sum_{j = 1}^{S} \\omega_{ij}N_{j,t}}$$

where $\\sigma_{i}$ is the survival probability of stage $i$, $\\sigma_{0,i}$ is its survival probability at low densities, $b$ is the strength of density dependence, $S$ indicates the number of stage, $\\omega_{ij}$ is contribution of stage $j$ to the density dependence in the fecundity of stage $i$ and $N_{j,t}$ the number of individuals in stage $j$ at time $t$ (e.g. [@caswellSensitivityAnalysisEquilibrium2004]). To allow for the possibility of having different strengths of density dependence in different processes, we introduce the coefficient $C_{\\sigma}$, which scales the strength of density dependence in survival relative to the strength of density dependence $b$ in fecundity.
Bernoulli trials $Bern(\\sigma_{i})$ determine if an individual develops to the next stage or not.
"}`

`r if(stage_structured & !develop_densdep & !develop_stagedep){"In this specific use case, development is neither density nor stage dependent. Bernoulli trials $Bern(\\gamma)$ determine if an individual develops to the next stage or not."}`
`r if(stage_structured & !survival_densdep & survival_stagedep){"In this specific use case, development is stage dependent. Bernoulli trials $Bern(\\gamma_{s})$ determine if an individual develops to the next stage or not. "}`

`r if(stage_structured & develop_densdep & !develop_stagedep){"In this specific use case, development into higher stages is density dependent. Density dependence in development is implemented as an exponential decay:
$\\gamma_{i} = \\gamma_{0,i}*e^{-C_{\\gamma}bN_{t}}$
where $\\gamma_{i}$ is the development probability of stage $i$, $\\gamma_{0,i}$ is its development probability at low densities, $b$ is the strength of density dependence and $N_{t}$ is the total number of individuals in the local population at time $t$. To allow for the possibility of having different strengths of density dependence in different processes, we introduce the coefficient $C_{\\gamma}$ scales the strength of density dependence in development relative to the strength of density dependence $b$ in fecundity.
Bernoulli trials $Bern(\\gamma_{i})$ determine if an individual develops to the next stage or not."}`

`r if(stage_structured & develop_densdep & develop_stagedep){"In this specific use case, development into higher stages is density dependent. Density and stage dependence in development is implemented as an exponential decay:
$\\gamma_{i} = \\gamma_{0,i}*e^{-C_{\\gamma}b\\sum_{j = 1}^{S} \\omega_{ij}N_{j,t}}}$
where $\\gamma_{i}$ is the development probability of stage $i$, $\\gamma_{0,i}$ is its development probability at low densities, $b$ is the strength of density dependence, $S$ indicates the number of stage, $\\omega_{ij}$ is contribution of stage $j$ to the density dependence in the fecundity of stage $i$ and $N_{j,t}$ the number of individuals in stage $j$ at time $t$ (e.g. [@caswellSensitivityAnalysisEquilibrium2004]). To allow for the possibility of having different strengths of density dependence in different processes, we introduce the coefficient $C_{\\gamma}$, which scales the strength of density dependence in development relative to the strength of density dependence $b$ in fecundity.
Bernoulli trials $Bern(\\gamma_{i})$ determine if an individual develops to the next stage or not.
"}`

`r if(cell_based & local_ext_prob){"RangeShifter implements random local extinction probability. In each year, every population has an identical probability of going extinct. This does not affect the demographic parameter but simply kills-off the local population."}`

## Emigration

Emigration is the first phase of dispersal. It is modeled as the probability that an individual will leave its natal patch during the present year. `r if(stage_structured){"If a stage having non-zero $d$ can last for more than one year, an individual has multiple opportunities to emigrate, each with probability $d$, and hence the realised overall emigration rate will be larger than $d$."}` The emigration probability $d$ is `r if(!emigration_densdep){"density-independent, and hence constant. "}``r if(emigration_densdep & !stage_structured){"density dependent. It is given by the following function, introduced by Kun and Scheuring [-@kunEvolutionDensityDependentDispersal2006] 

$$d = \\dfrac{D_{0}}{1 + e^{-(N_{i,t}/K_{i,t}-\\beta)\\alpha}}$$

Here, $D_{0}$ is the maximum emigration probability, $\\beta$ is the inflection point of the function and $\\alpha$ is the slope at the inflection point. We chose this one because it is a flexible function that allows for modeling a range of different reaction norms, as well as their emergence through evolution. We assume individuals to have full knowledge of the population density and habitat quality in their natal patch. Information acquisition is not explicitly modeled in RangeShifter."}``r if(emigration_densdep & stage_structured){"density dependent. It is given by the following function, introduced by Kun and Scheuring [-@kunEvolutionDensityDependentDispersal2006] 

$$d = \\dfrac{D_{0}}{1 + e^{-(b_{i,t}N_{i,t}-\\beta)\\alpha}}$$

Here, $D_{0}$ is the maximum emigration probability, $\\beta$ is the inflection point of the function, $\\alpha$ is the slope at the inflection point and $b$ represents the strength of density dependence used for the population dynamics. We chose this one because it is a flexible function that allows for modeling a range of different reaction norms, as well as their emergence through evolution. We assume individuals to have full knowledge of the population density and habitat quality in their natal patch. Information acquisition is not explicitly modeled in RangeShifter."}`

`r if(!emigration_sexdep & !emigration_stagedep){"The emigration probability is the same and fixed for every individual."}` 

`r if(emigration_sexdep & !emigration_stagedep & emigration_densdep){"Emigration probability is modelled sex-specific. Thus, each sex has different emigration parameters."}`

`r if(emigration_stagedep & !emigration_sexdep & emigration_densdep){"Emigration probability is modelled stage-specific. Thus, each stage has different emigration parameters."}`

`r if(emigration_stagedep & emigration_sexdep & emigration_densdep){"Emigration probability is modelled stage- and sex-specific. Thus, each stage and sex has different emigration parameters."}`


`r if(emigration_sexdep & !emigration_stagedep & !emigration_densdep){"Emigration probability is modelled sex-specific. Thus, each sex has different emigration parameter."}`

`r if(emigration_stagedep & !emigration_sexdep & !emigration_densdep){"Emigration probability is modelled stage-specific. Thus, each stage has different emigration parameter."}`

`r if(emigration_stagedep & emigration_sexdep & !emigration_densdep){"Emigration probability is modelled stage- and sex-specific. Thus, each stage and sex has different emigration parameter."}`


## Transfer

`r if(cell_based){"Transfer is the second phase of dispersal, and consists of the movement of an individual starting from when it emigrates from its natal cell and ending with settlement in another cell or mortality. The main components of this phase are the individual movement ability and navigation capacity in response to the characteristics of the environment. The interaction between these components and their associated costs will determine the distance moved, the movement path and the chance of surviving the transfer phase."}`

`r if(patch_based){"Transfer is the second phase of dispersal, and consists of the movement of an individual starting from when it emigrates from its natal patch and ending with settlement in another patch or mortality. The main components of this phase are the individual movement ability and navigation capacity in response to the characteristics of the environment. The interaction between these components and their associated costs will determine the distance moved, the movement path and the chance of surviving the transfer phase."}`

`r if(dispersal_kernel){"The transfer phase is modeled as phenomenological dispersal kernel. The kernel is considered as 'distance kernel', i.e. the statistical distribution of the probability that an individual will move a certain distance [@hovestadtEvolutionEmergenceDispersal2012; @nathanDispersalKernelsReview2012]. The dispersal kernel is only applied to dispersing individuals. If the individual disperses, the distance and the movement direction are determined in continuous space."}`
`r if(dispersal_kernel_simple){"The distance is drawn from a negative exponential distribution with a given mean $\\delta$, and the direction is selected randomly from a uniform distribution between 0 and 2$\\pi$ radians."}` `r if(dispersal_kernel_mixed){"The distance an individual moves is sampled from a mixed kernel given by the combination of two negative exponentials with different means $\\delta_{1}$ and $\\delta_{2}$, occurring with probability $p$ and $1-p$ respectively (Hovestadt et al. 2011). The direction is selected randomly from a uniform distribution between 0 and 2$\\pi$ radians."}`
`r if(dispersal_kernel){"If the arrival point lies beyond the boundary of the landscape, distance and direction are re-drawn."}``r if(cell_based & dispersal_kernel){"The individual is displaced from a random point (using continuous coordinates) inside the natal cell to the arrival cell where the model switches back to discrete space [@bocediProjectingSpeciesRange2012a]. If the arrival point is inside the natal cell, individual starting position, distance and direction are re-sampled until the individual leaves the natal cell."}``r if(patch_based & dispersal_kernel){"The individual is assumed to disperse from a random point in the natal patch and this position, the dispersal distance and direction are drawn until the individual leaves the patch."}`
 
`r if(dispersal_kernel & emigration_densdep){"In order to separate emigration and transfer explicitly, and to avoid potential infinite re-sampling, the program requires the mean of the kernel to be greater or equal the cell resolution."}` 

`r if(dispersal_kernel & !emigration_densdep){"The kernel is applied to the entire population without re-sampling. Individuals which draw a short movement distance do not leave the natal "}`
`r if(cell_based & dispersal_kernel & !emigration_densdep){"cell"}``r if(patch_based & dispersal_kernel & !emigration_densdep){"patch"}`
`r if(dispersal_kernel & !emigration_densdep){" and implicitly become sedentary, and therefore the kernel itself defines the proportion of individuals which emigrate."}`

`r if(dispersal_kernel & !emigration_densdep & emigration_sexdep & emigration_stagedep){"The emigration probability for those stages and sexes which disperse is set to 1.0; otherwise, only a proportion of such individuals would use the kernel to determine whether or not they emigrate."}`

`r if(dispersal_kernel & !emigration_densdep & emigration_sexdep & !emigration_stagedep){"The emigration probability for those sexes which disperse is set to 1.0; otherwise, only a proportion of such individuals would use the kernel to determine whether or not they emigrate."}`

`r if(dispersal_kernel & !emigration_densdep & !emigration_sexdep & emigration_stagedep){"The emigration probability for those stages which disperse is set to 1.0; otherwise, only a proportion of such individuals would use the kernel to determine whether or not they emigrate."}`

`r if(movement_model){"The movement model is fully individual-based and explicitly decribes the movement behaviour of individuals with a level of detail, and hence parameters, which is probably close to the most parsimonious for a mechanisctic movement model."}`

`r if(movement_SMS){"The stochastic movement simulator (SMS) is a stochastic individual-based model where organisms move through the grid-based, landscape. The model uses similar cost surfaces as the least cost path (LCP) [@adriaensenApplicationLeastcostModelling2003; @chardonIncorporatingLandscapeElements2003; @stevensGeneFlowFunctional2006; @driezenEvaluatingLeastcostModel2007], but it relaxes two of the main assumptions/limitations of the latter. Firstly, individuals are not assumed to be omniscient, but move according to what they can perceive of the landscape within their perceptual range. Secondly, individuals do not know a priori their final destination, which is a reasonable assumption for dispersing individuals. Here, the core components of SMS are briefly described; see Palmer et al. [-@palmerIntroducingStochasticMovement2011] for a complete description of the method."}`
`r if(movement_SMS & habitat_type){"SMS uses cost maps where a relative cost to movement is assigned to each habitat type. Costs are integer numbers and represent the cost of moving through a particular land cover relative to the cost of moving through breeding habitat (conventionally set to a cost of 1). "}``r if(movement_SMS & habitat_quality){"SMS uses cost maps with a relative cost to movement is assigned to each habitat cell. Costs are integer numbers and represent the cost of moving through a particular cell relative to the cost of moving through breeding habitat (conventionally set to a cost of 1). "}`
`r if(movement_SMS){"Individuals take single-cell steps basing their decisions on three parameters: their perceptual range $PR$, the method used to evaluate the landscape within their perceptual range and their directional persistence $DP$, which corresponds to their tendency to follow a correlated random walk. The $PR$ is defined by a number of cells. At each step, the individual evaluates the surrounding habitat in order to determine the effective cost of taking a particular step to each of the eight neighbouring cells. The effective cost is a mean of the cost of the neighbouring cell and the surrounding cells beyond it within the $PR$, and is calculated by "}``r if(movement_SMS & movement_SMS_PRmethod == 1){"arithmetic mean."}``r if(movement_SMS & movement_SMS_PRmethod == 2){"harmonic mean."}``r if(movement_SMS & movement_SMS_PRmethod == 3){"weighted arithmetic mean."}` `r if(movement_SMS){"The effective cost of each neighbouring cell is weighted by the $DP$, which is lowest in the direction of travel. Specifically, $DP$ is raised to the power 4 in the direction of travel, to the power 3 at 45$^\\circ$  to the direction of travel and so on down to the power 0 at 180$^\\circ$  to the direction of travel. Thus, for example, if $DP$ is set to 3.0, an individual is 9 times more likely to continue in its current direction (assuming homogeneous costs) than it is to make a right-angle turn, and 81 times more likely to go straight on than to turn around and retrace its last move. $DP$ can be calculated over more steps that just the previous one (up to a maximum of 14), controlled by the memory size parameter $MemSize$ [@palmerInterindividualVariabilityDispersal2014; @abenSimpleIndividualbasedModels2014]. Increasing the memory size means that an individual retains for longer its tendency to move in a certain direction, and hence paths tend to become somewhat smoother. "}``r if(movement_SMS & goal_type==2){"A goal bias $GB$ was included, i.e. a tendency to move towards a particular destination [@abenSimpleIndividualbasedModels2014]. It is applied only in the ‘negative’ sense of moving away from the natal location, i.e. as a dispersal bias, which is implemented in a similar way to $DP$ but relative to the direction from the natal site to the current location. Moreover, dispersal bias is subject to a decay in strength as a function of the accumulated number of steps taken. This enables a dispersal path to follow a straighter trajectory initially, and later become more tortuous and responsive to perceived landscape costs. The reciprocals of the product of effective cost, $DP$ and dispersal bias, scaled to sum to one, give the probabilities that the individual will move to each neighbouring cell."}`
`r if(movement_SMS & goal_type!=2){"The reciprocals of the product of effective cost and $DP$ , scaled to sum to one, give the probabilities that the individual will move to each neighbouring cell. "}``r if(movement_SMS){"All the dispersing individuals move simultaneously, i.e. at each time-step they all make one move."}` `r if(movement_SMS & patch_based){"the individual is forced to leave the natal patch by increasing its $DP$ ten-fold until it has taken a number of steps (equal to twice the perceptual range) outside the natal patch."}`

`r if(movement_corrRW){"A simple correlated random walk without any bias is implemented. This model is implemented in continuous space on the top of the landscape grid. Individuals take steps of a constant step length (metres); the direction is sampled from a wrapped Cauchy distribution having a correlation parameter $\\rho$ in the range 0 to 1 [@zollnerSearchStrategiesLandscapeLevel1999; @bartonEvolutionIntelligentDispersal2009]. All individuals take each step simultaneously."}``r if(movement_corrRW & patch_based){"$\\rho$ is automatically set to 0.99 until the individual steps outside the natal patch, after which the value of $\\rho$ set by the user is restored."}`

## Settlement

Settlement, or immigration, is the last phase of dispersal, when the organism stops in a new `r if(cell_based){"cell"}``r if(patch_based){"patch"}` of breeding habitat. Dispersing individuals are not allowed to settle in their natal `r if(cell_based){"cell"}``r if(patch_based){"patch"}`.
`r if(dispersal_kernel){"Individuals are displaced directly from the starting location to the arrival location.The suitability of the arrival"}``r if(dispersal_kernel & cell_based){"cell"}``r if(dispersal_kernel & patch_based){"patch"}``r if(dispersal_kernel){"determines whether the disperser is successful or not."}` `r if(dispersal_kernel & !stage_structured & cell_based){"The model has two options if the arrival cell is unsuitable: the individual either dies or it can move to one of the eight neighbouring cells in the case that at least one of them is suitable. In the latter case, if more than one of the neighbouring cells is suitable, the individual is placed in one of them chosen randomly."}``r if(dispersal_kernel & !stage_structured & patch_based){"The model has two options if the arrival cell is unsuitable: the individual either dies or can move to a randomly chosen neighbouring suitable patch, provided that the new patch is only one cell apart from the arrival patch."}``r if(dispersal_kernel & stage_structured & cell_based){"The model has four options if the arrival cell is unsuitable: (1) the individual dies, (2) it can move to a randomly chosen neighboring suitable cell, (3) the individual can stay there waiting until the next dispersal event when it will disperse again according to the set kernel, (4) if both the arrival cell and all eight neighbouring cells are unsuitable the individual can wait in the arrival cell before moving again at the next dispersal event."}``r if(dispersal_kernel & stage_structured & patch_based){"The model has four options if the arrival cell is unsuitable: (1) the individual dies, (2) it can move to a randomly chosen neighbouring suitable patch, provided that the new patch is only one cell apart from the arrival patch, (3) the individual can stay there waiting until the next dispersal event when it will disperse again according to the set kernel, (4) if both the arrival patch and all eventual neighbouring patches are unsuitable the individual can wait in the arrival patch before moving again at the next dispersal event."}`
`r if(dispersal_kernel & cell_based){"The arrival cell is considered suitable if it contains breeding habitat. "}` `r if(dispersal_kernel & patch_based){"The arrival patch is considered suitable if it contains breeding habitat. "}` `r if(dispersal_kernel & cell_based & mate_finding){"Additionally, individuals are required to find a mate, i.e. there has to be at least one individual of the opposite sex present for the cell to be considered suitable for settlement."}` `r if(dispersal_kernel & patch_based & mate_finding){"Additionally, individuals are required to find a mate, i.e. there has to be at least one individual of the opposite sex present for the patch to be considered suitable for settlement."}`

`r if(movement_model & cell_based){"At each step (made simultaneously) dispersing individuals each evaluate their current cell for the possibility of settling."}` `r if(movement_model & patch_based){"At each step (made simultaneously) dispersing individuals each evaluate their current patch for the possibility of settling. "}` `r if(movement_model){"The individual decides to stop if there is suitable habitat; this is a necessary condition. "}``r if(movement_model & settlement_densdep){"Additionally, the settlement decision is density-dependent. The individual has a probability $p_{s}$ of settling in the "}` `r if(movement_model & settlement_densdep & cell_based){"cell"}``r if(movement_model & settlement_densdep & patch_based){"patch"}``r if(movement_model & settlement_densdep){" $i$, given by:"}`
`r if(movement_model & settlement_densdep & !stage_structured & cell_based){"

$$p_{s} = \\dfrac{S_{0}}{1+e^{-(N_{i}/K_{i}-\\beta_{i})*\\alpha_{s}}}$$

Here, $N_{i}$ and $K_{i}$ are the number of individuals and the carrying capacity of the cell $i$, $S_{0}$ is the maximum settlement probability, $\\beta_{s}$ is the inflection point and $\\alpha_{s}$ is the slope of the function."}`
`r if(movement_model & settlement_densdep & !stage_structured & patch_based){"

$$p_{s} = \\dfrac{S_{0}}{1+e^{-(N_{i}/K_{i}-\\beta_{i})*\\alpha_{s}}}$$

Here, $N_{i}$ and $K_{i}$ are the number of individuals and the carrying capacity of the patch $i$, $S_{0}$ is the maximum settlement probability, $\\beta_{s}$ is the inflection point and $\\alpha_{s}$ is the slope of the function."}`
`r if(movement_model & settlement_densdep & stage_structured & cell_based){"

$$p_{s} = \\dfrac{S_{0}}{1+e^{-(bN_{i}-\\beta_{i})*\\alpha_{s}}}$$

Here, $N_{i}$ is the number of individuals of the cell $i$, $b$ represents the strength of density dependence used for the population dynamics, $S_{0}$ is the maximum settlement probability, $\\beta_{s}$ is the inflection point and $\\alpha_{s}$ is the slope of the function."}`
`r if(movement_model & settlement_densdep & stage_structured & patch_based){"

$$p_{s} = \\dfrac{S_{0}}{1+e^{-(bN_{i}-\\beta_{i})*\\alpha_{s}}}$$

Here, $N_{i}$ is the number of individuals of the patch $i$, $b$ represents the strength of density dependence used for the population dynamics, $S_{0}$ is the maximum settlement probability, $\\beta_{s}$ is the inflection point and $\\alpha_{s}$ is the slope of the function."}`
`r if(movement_model & settlement_densdep & cell_based & mate_finding){"Individuals are required to find a mate in order to settle. This requirement is satisfied if there is at least one individual of the opposite sex in the cell."}`
`r if(movement_model & settlement_densdep & patch_based & mate_finding){"Individuals are required to find a mate in order to settle. This requirement is satisfied if there is at least one individual of the opposite sex in the patch."}`

`r if(step_mortality | max_steps){"To avoid having individuals moving perpetually because they cannot find suitable conditions to settle, the model includes "}``r if(step_mortality & max_steps){"a per-step mortality and a maximum number of steps."}``r if(step_mortality & !max_steps){"a per-step mortality."}``r if(!step_mortality & max_steps){"a maximum number of steps."}` `r if(max_steps){"The maximum number of steps defines the maximum time length of the transfer period. When an individual reaches the maximum number of steps, it stops where it is regardless of the suitability of the location."}``r if(max_steps & !stage_structured){"This results in automatic death if the individual stops in unsuitable habitat."}``r if(max_steps & stage_structured){"In the next season, if still alive, it will move again."}`

`r if(min_steps){"Additionally, a minimum number of steps that each individual must take before settlement is set simulating situations where animals, in a ‘dispersal mode’, will keep moving and not consider settling even if suitable conditions are available (e.g. [@bartonRiskyMovementIncreases2012])."}`
`r if(settlement_sexdep & settlement_stagedep){"Settlement rules are sex- and stage-specific."}`
`r if(settlement_sexdep & !settlement_stagedep){"Settlement rules are sex-specific."}`
`r if(!settlement_sexdep & settlement_stagedep){"Settlement rules are stage-specific."}`

## Aging

Aging occurs at the end of each year.

# Model parameter settings of the specific use case

```{r echo=F, include=T}
# create a data.frames with all the parameter settings
# help function to transform any arrays to latex
 array_to_LaTeX <- function(arr){
  rows <- apply(arr, MARGIN=1, paste, collapse = " & ")
  matrix_string <- paste(rows, collapse = " \\\\ ")
  return(paste("$$\\begin{bmatrix}", matrix_string, "\\end{bmatrix}$$"))
 }
 
range <- paste(s@init@minX, s@init@maxX, s@init@minY, s@init@maxY)
PropStages <- as.vector(s@init@PropStages)
res <- toString(PropStages)
if(real_land){
  nb_landscapes <- length(s@land@LandscapeFile)
  # LandscapeFile <- as.vector(s@land@LandscapeFile)
    
  Nhabitats <- as.vector(s@land@Nhabitats)
  Nhabitats <- toString(Nhabitats)
  
  K_or_DensDep <- as.vector(s@land@K_or_DensDep)
  K_or_DensDep <- toString(K_or_DensDep)
  
  PatchFile <- as.vector(s@land@PatchFile)
  PatchFile <- toString(PatchFile)
  
  CostsFile <- as.vector(s@land@CostsFile)
  CostsFile <- toString(CostsFile)
  
  DynamicLandYears <- as.vector(s@land@DynamicLandYears)
  DynamicLandYears <- toString(DynamicLandYears)
}

if(stage_structured){
  # prepare transition matrix for output
  matrix <- array_to_LaTeX(s@demog@StageStruct@TransMatrix)
  
  # prepare minage for output
  MinAge <-toString(s@demog@StageStruct@MinAge)
  
  # prepare weight matrices for output
  if(s@demog@StageStruct@FecStageWts){
    FecStageWtsMatrix <- array_to_LaTeX(s@demog@StageStruct@FecStageWtsMatrix)
  } else {FecStageWtsMatrix="Not selected."}

  if(s@demog@StageStruct@DevStageWts){
    DevStageWtsMatrix <- array_to_LaTeX(s@demog@StageStruct@DevStageWtsMatrix)
  } else {DevStageWtsMatrix="Not selected."}
  
  if(s@demog@StageStruct@SurvStageWts){
    SurvStageWtsMatrix <- array_to_LaTeX(s@demog@StageStruct@SurvStageWtsMatrix)
  } else {SurvStageWtsMatrix="Not selected."}
}

if(class(s@dispersal@Emigration@EmigProb)[1]=="matrix"){
  emigprob <- array_to_LaTeX(s@dispersal@Emigration@EmigProb)
} else emigprob <- s@dispersal@Emigration@EmigProb

if(dispersal_kernel){
  if(class(s@dispersal@Transfer@Distances=="matrix")){
    Distances <- array_to_LaTeX(s@dispersal@Transfer@Distances)
  }else Distances <- s@dispersal@Transfer@Distances
} 
  


if(movement_SMS){
  if(class(s@dispersal@Transfer@Costs)=="numeric"){
    Costs <- toString(s@dispersal@Transfer@Costs)
  }else Costs <- as.character(s@dispersal@Transfer@Costs)
  
  if(length(s@dispersal@Transfer@StepMort)>1){
    StepMort_SMS <- toString(s@dispersal@Transfer@StepMort)
  } else StepMort_SMS <- s@dispersal@Transfer@StepMort
} 

if(movement_corrRW){
  if(length(s@dispersal@Transfer@StepMort)>1){
    StepMort_CorrRW <- toString(s@dispersal@Transfer@StepMort)
  } else StepMort_CorrRW <- s@dispersal@Transfer@StepMort
} 

Settle<- array_to_LaTeX(s@dispersal@Settlement@Settle)


Simulation <- data.frame(
  "Parameter         "=c(
    "Year",
    "Replicates",
    "Absorbing","",
    "LocalExt",
    "LocalEctProb",
    "EnvStoch", "",
    "EnvStochType",  "", "", 
    "std",
    "ac",
    "minR",
    "maxR",
    "minK",
    "maxK",
    "OutIntRange",
    "OutIntOcc",
    "OutIntPop",
    "OutIntInd",
    "OutIntConn",
    "OutIntPaths",
    "OutStartPop",
    "OutStartInd",
    "OutStartConn",
    "OutStartPaths",
    "SMSHeatMap"
  ),
  "Description"=c(
    "Number of simulated years",
    "Number of simulation iterations",
    "Whether non-valid cells lead to direct",    "mortality of the individual during transfer",
    "Local extinction",
    "Local extinction probability",
    "Environmental stochasticity", "(0: none, 1: global, 2: local)",
    "Parameter on which environmental", "stochasticity acts (0: growth rate/fecundity,", "1: demographic density dependence)",
    "Magnitude of stochastic fluctuations",
    "Temporal autocorrelation coefficient",
    "Minimum growth rate",
    "Maximum growth rate",
    "Minimum density dependence value",
    "Maximum density dependence value",
    "Output of range file",
    "Output of occupancy file",
    "Output of population file",
    "Output of individual file",
    "Output of connectivity file",
    "Output of SMS paths file",
    "Starting year for output population file",
    "Starting year for output individual file",
    "Starting year for output connectivity file",
    "Starting year for output SMS paths file",
    "Output SMS heat map raster file"
  ),
  "Values"=c(
    as.character(s@simul@Years),
    as.character(s@simul@Replicates),
    as.character(s@simul@Absorbing),"",
    as.character(s@simul@LocalExt),
    as.character(s@simul@LocalExtProb),
    as.character(s@simul@EnvStoch), "",
    as.character(s@simul@EnvStochType), "", "",
    as.character(s@simul@std),
    as.character(s@simul@ac),
    as.character(s@simul@minR),
    as.character(s@simul@maxR),
    as.character(s@simul@minK),
    as.character(s@simul@maxK),
    as.character(s@simul@OutIntRange),
    as.character(s@simul@OutIntOcc),
    as.character(s@simul@OutIntPop),
    as.character(s@simul@OutIntInd),
    as.character(s@simul@OutIntConn),
    as.character(s@simul@OutIntPaths),
    as.character(s@simul@OutStartPop),
    as.character(s@simul@OutStartInd),
    as.character(s@simul@OutStartConn),
    as.character(s@simul@OutStartPaths),
    as.character(s@simul@SMSHeatMap))
  )

Initialisation <- data.frame(
  "Parameter                     "=c(
    "InitType", "", "", "", 
    "FreeType", "", "", 
    "NrCells",
    "SpType", "", "", "", "",
    "InitIndsFile",
    "InitDens", "", "", "", 
    "IndsHaCell",
    "PropStages",
    "InitAge", "", "", "", "",
    "minX, maxX, minY, maxY",
    "InitFreezeYear", "",
    "RestrictRows", "",
    "RestrictFreq", "",
    "FinalFreezeYear", "", ""
  ),
  "Description                        "=c(
    "Type of initialisation", "(0: free initialisation according to habitat map,", "1: from loaded species distribution map, ", "2: from initial individuals list file)",
    "Option for free initialisation ", "(0: random in given number of cells, ", "1: all suitable cells/patches)",
    "Number of cells to initialise",
    "Option for initialisation from ", "species distribution map (0: all suitable cells within ", "all distribution presence cells, ", "1: all suitable cells within given ", "number of randomly chosen presence cells)",
    "Name if the initial individuals list file",
    "Number of individuals seeded in each cell/patch ", "(0: at demographic density dependence, ", "1: at half of the demographic density dependence, ", "2: according to quasi-equilibrium distribution)",
    "Specified number of individuals per hectare",
    "Proportion of initialised individuals in each stage",
    "Initial age distribution ","(0: minimum age for the respective stage, ","1: random age between the minimum ","and maximum age for the respective stage, ","2: according to a quasi-equilibrium distribution)",
    "Restrict initial range",
    "Year until which species is ","confined to its initial range limits",
    "Number of rows at northern ","front to restrict range.",
    "Frequency in years at which ","range is restricted to northern front.",
    "The year after which species is ","confined to its new, current range limits, ","after a period of range expansion."
  ),
  "Values"=c(
    as.character(s@init@InitType), "", "", "", 
    as.character(s@init@FreeType), "", "", 
    as.character(s@init@NrCells),
    as.character(s@init@SpType), "", "", "", "",
    as.character(s@init@InitIndsFile),
    as.character(s@init@InitDens), "", "", "", 
    as.character(s@init@IndsHaCell),
    res,
    as.character(s@init@InitAge), "", "", "", "",
    range,
    as.character(s@init@InitFreezeYear), "",
    as.character(s@init@RestrictRows), "",
    as.character(s@init@RestrictFreq), "",
    as.character(s@init@FinalFreezeYear), "", "")
  )

if(real_land){
  Landscape <- data.frame(
    "Parameter         "=c(
      "Landscape file",
      rep("", nb_landscapes-1),
      "Resolution",
      "HabPercent",
      "NHabitats",
      "K_or_DensDep",
      "PatchFile",
      "CostsFile",
      "DynamicLandYears",
      "SpDistFile",
      "SpDistResolution"
    ),
    "Description                                  "=c(
      "Filename(s) of the landscape map(s)",
      rep("", nb_landscapes-1),
      "Resolution in meters",
      "Whether habitat types/codes or habitat cover/quality",
      "Number of different habitat codes",
      "Demographic density dependence",
      "Filename(s) of the patch map(s)",
      "Filename(s) of the SMS cost map(s)",
      "Years of landscape changes",
      "Filename of the species initial distribution map",
      "Resolution of the distribution map in meters"
    ),
    "Values"=c(
      rep("", nb_landscapes),
      s@land@Resolution,
      s@land@HabPercent,
      Nhabitats,
      K_or_DensDep,
      "", # PatchFile,
      "", # CostsFile,
      DynamicLandYears,
      "",# s@land@SpDistFile,
      s@land@SpDistResolution
    ))
}

if(arti_land){
  Landscape <- data.frame(
    "Parameter             "=c(
      "propSuit",
      "K_orDensDep",
      "Resolution",
      "dimX",
      "dimY",
      "fractal",
      "hurst",
      "continuous",
      "minPct",
      "maxPct"
    ),
    "Description                                  "=c(
      "Proportion of suitable habitat cells",
      "Demographic density dependence",
      "Resolution in meters",
      "Number of cells along the x-axis",
      "Number of cells along the y-axis",
      "Whether a random or fractal landscape is generated",
      "Hurst exponent",
      "Continuous or binary habitat",
      "Minimum percentage of habitat cover within a cell",
      "Maximum percentage of habitat cover within a cell"
    ),
    "Values"=c(
      s@land@propSuit,
      s@land@K_or_DensDep,
      s@land@Resolution,
      s@land@dimX,
      s@land@dimY,
      s@land@fractal,
      s@land@continuous,
      s@land@minPct,
      s@land@maxPct
    ))
}

if(s@demog@Rmax>0){
  Demography <- data.frame(
    "Parameter"=c(
      "Rmax", "",
      "bc", "",
      "ReproductionType","", "", "",
      "PropMales",
      "Harem"
    ),
    "Description"=c(
      "Maximum growth rate ","(number of offspring per female at very low density)",
      "Competition coefficient ","(describes the type of density regulation)",
      "Decribes the reproduction type ","(0: asexual/only female; ","1: simple sexual model; ","2: sexual model with explicit mating system)",
      "Proportion of males in the population",
      "Maximum harem size"
    ),
    "Values"=c(
      as.character(s@demog@Rmax), "",
      as.character(s@demog@bc),"",
      as.character(s@demog@ReproductionType),"", "", "",
      as.character(s@demog@PropMales),
      as.character(s@demog@Harem)
    )
  )
}

if(s@demog@Rmax<0){
  Demography <- data.frame(
    "Parameter     "=c(
      "Stages",
      "TransMatrix","", "", "",
      "MaxAge",
      "MinAge","", "",
      "RepSeasons",
      "RepInterval","","",
      "PRep","",
      "SurvSched","","",
      "FecDensDep","",
      "DevDensDep","",
      "SurvDensDep","",
      "DevDensCoeff","",
      "SurvDensCoeff","",
      "FecStageWtsMatrix","",
      "DevStageWtsMatrix","",
      "SurvStageWtsMatrix","",
      "PostDestrictn","","",
      "ReproductionType","","",
      "PropMales",
      "Harem"
    ),
    "Description"=c(
      "Number of life stages",
      "Transition matrix. ","Defines the development probabilities ","from each stage into the next as well as the ","respective survival probabilities and fecundities",
      "Maximum age in years",
      "Ages which an individual in stage ","i-1 must already have reached before ","it can develop into the next stage i.",
      "Number of potential reproduction events per year",
      "Number of reproductive seasons ","which must be missed following a reproduction attempt ","before another reproduction attempt may occur",
      "Probability of reproducing in ","subsequent reproductive seasons",
      "Scheduling of survival ","(0: at reproduction, 1: between reproductive events, ","2: annually)",
      "whether density dependent ","fecundity probability is modelled",
      "Whether density dependent ","development probability is modelled",
      "Whether density dependent ","survival probability is modelled",
      "Relative density dependence ","coefficient for development",
      "Relative density dependence ","coefficient for survival",
      "Stage-dependent weights ","in density dependence of fecundity",
      "Stage-dependent weights ","in density dependence of development",
      "Stage dependent weights ","in density dependence of survival",
      "Whether individuals of a population "," die (FALSE) or disperse (TRUE) ","if its patch gets destroyed",
      "Decribes the reproduction type ","(0: asexual/only female; 1: simple sexual model; ","2: sexual model with explicit mating system)",
      "Proportion of males in the population",
      "Maximum harem size"
    ),
    "Values"=c(
      s@demog@StageStruct@Stages,
      matrix,"", "", "",
      s@demog@StageStruct@MaxAge,
      MinAge,"", "",
      s@demog@StageStruct@RepSeasons,
      s@demog@StageStruct@RepInterval,"","",
      s@demog@StageStruct@PRep,"",
      s@demog@StageStruct@SurvSched,"","",
      s@demog@StageStruct@FecDensDep,"",
      s@demog@StageStruct@DevDensDep,"",
      s@demog@StageStruct@SurvDensDep,"",
      s@demog@StageStruct@DevDensCoeff,"",
      s@demog@StageStruct@SurvDensCoeff,"",
      FecStageWtsMatrix,"",
      DevStageWtsMatrix,"",
      SurvStageWtsMatrix,"",
      s@demog@StageStruct@PostDestructn,"","",
      s@demog@ReproductionType,"","",
      s@demog@PropMales,
      s@demog@Harem
    )
  )
}  

# create df for each type of transfer

# DispersalKernel
if(dispersal_kernel){
  transfer <- data.frame("Parameter"=c(
    "Type",
    "Distances","","",
    "DoubleKernel",
    "SexDep",
    "StageDep",
    "DistMort",
    "MortProb",
    "InflPoint",
    "Slope"),
    "Description"=c(
      "Type of transfer",
      "Matrix containing all dispersal kernel parameters","(#columns) for each stage/sex (#rows).", "Its structure depends on the other parameters.",
      "Use a mixed (i.e. double negative exponential) kernel?",
      "Sex-dependent dispersal kernel?",
      "Stage-dependent dispersal kernel?",
      "Distance-dependent mortality probability?",
      "Constant mortality probability",
      "Inflection point for the mortality distance dependence function.",
      "Slope at inflection point for the mortality distance dependence function."
    ),
    "Values"=c(
      as.character(class(s@dispersal@Transfer)),
      Distances,"","",
      as.character(s@dispersal@Transfer@DoubleKernel),
      as.character(s@dispersal@Transfer@SexDep),
      as.character(s@dispersal@Transfer@StageDep),
      as.character(s@dispersal@Transfer@DistMort),
      as.character(s@dispersal@Transfer@MortProb),
      as.character(s@dispersal@Transfer@InflPoint),
      as.character(s@dispersal@Transfer@Slope)
    )
  )
}

if(movement_SMS){
  transfer <- data.frame("Parameter"=c(
    "Type",
    "PR",
    "PRMethod","","","","","",
    "MemSize","","",
    "DP","",
    "GoalType","",
    "GoalBias",
    "AlphaDB",
    "BetaDB",
    "Costs","","","",
    "StepMort",
    "StraightenPath"
    ),
    "Description"=c(
      "Type of transfer",
      "Perceptual range",
      "Method to evaluate the effective cost"," of a particular step from the landdscape"," within the perceptual range:", "1: Arithmetic mean", "2: Harmonic mean", "Weighted arithmetic mean",
      "Size of memory, given as the number of previous steps"," over which to calculate current direction"," to apply directional persistence",
      "Directional persistence. Corresponds to the","tendency to follow a correlated random walk.",
      "Goal bias type","0: None, 2: dispersal bias",
      "Goal bias strength",
      "Dispersal bias decay rate",
      "Dispersal bias decay inflection point (number of steps)",
      "Describes the landscapes resistance to movement:","Either habitat-specific costs for each habitat type","or 'file', to indictae to use the cost raster map(s)","specified in the landscape module.",
      "Per-step mortality probability: constant or habitat-specific",
      "Straighten path after decision not to settle in a patch?"
    ),
    "Values"=c(
      as.character(class(s@dispersal@Transfer)),
      s@dispersal@Transfer@PR,
      s@dispersal@Transfer@PRMethod,"","","","","",
      s@dispersal@Transfer@MemSize,"","",
      s@dispersal@Transfer@DP,"",
      s@dispersal@Transfer@GoalType,"",
      s@dispersal@Transfer@GoalBias,
      s@dispersal@Transfer@AlphaDB,
      s@dispersal@Transfer@BetaDB,
      Costs,"","","",
      StepMort_SMS,
      as.character(s@dispersal@Transfer@StraightenPath)
    ))
}

if(movement_corrRW) {
  transfer <- data.frame("Parameter"=c(
    "Type",
    "StepLength",
    "Rho",
    "StraightenPath",
    "StepMort"
  ),
  "Description"=c(
    "Type of transfer",
    "Step length given in meters",
    "Correlation parameter",
    "Straighten path after decision not to settle in a patch?",
    "Per-step mortality probability: constant or habitat-specific"
  ),
  "Values"=c(
    as.character(class(s@dispersal@Transfer)),
    s@dispersal@Transfer@StepLength,
    s@dispersal@Transfer@Rho,
    s@dispersal@Transfer@StraightenPath,
    StepMort_CorrRW
  )
  )
}


Dispersal <- data.frame(
  "Process                       "=c(
    "Emigration                  ","", "","","",
    # "Transfer                    ", rep("",nrow(transfer)-1),
    "Settlement                  ", if(!dispersal_kernel){rep("",8)} else{rep("",5)}
  ),
  "Parameter                     "=c(
    # Emigration
    "EmigProb",            # can be Matrix or single value
    "SexDep",
    "StageDep",
    "DensDep", 
    "UseFullKern",
    #Transfer
    # transfer$Parameter,
    "DensDep",
    "SexDep",
    "StageDep",
    "Settle","",if(dispersal_kernel){rep("",4)},
    if(!dispersal_kernel){c("MinSteps",
    "MaxSteps",
    "MaxStepsYear")},
    "FindMate"
  ),
  "Description                        "=c(
    #Emigration
    "Emigration probabilities/parameters for each stage/sex",
    "Sex-dependent emigration probability?",
    "Stage-dependent emigration probability?",
    "Density-dependent emigration probability?",
    "Shall the emigration probability be derived from dispersal kernel?",
    #Transfer
    # transfer$Description,
    #Settlement
    "Density-dependent settlement requirements?",
    "Sex-dependent settlement requirements?",
    "Stage-dependent settlement requirements?",
    if(dispersal_kernel){"Settlement codes (for DispersalKernel)"}
      else {"Settlement probability parameters"}
      ,"for all stages/sexes.",
    if(dispersal_kernel){c("0 = die (default)","1 = wait (stage-structured models only)","2 = randomly choose a suitable neighbouring cell or die","3 = randomly choose a suitable neighbouring cell"," or wait (stage-structured models only)")},
    if(!dispersal_kernel){c("Minimum number of steps",
    "Maximum number of steps",
    "Maximum number of steps per year")},
    "Mating requirements to settle?"
  ),
  "Values"=c(
    #emigration
    emigprob,
    as.character(s@dispersal@Emigration@SexDep),
    as.character(s@dispersal@Emigration@StageDep), 
    as.character(s@dispersal@Emigration@DensDep),
    as.character(s@dispersal@Emigration@UseFullKern),
    #Transfer
    # transfer$Values,
    #Settlement
    as.character(s@dispersal@Settlement@DensDep),
    as.character(s@dispersal@Settlement@SexDep),
    as.character(s@dispersal@Settlement@StageDep),
    Settle, if(dispersal_kernel){rep("",6)} else{""},
    if(movement_model){c(s@dispersal@Settlement@MinSteps,
      s@dispersal@Settlement@MaxSteps,
      s@dispersal@Settlement@MaxStepsYear)
    },
    toString(s@dispersal@Settlement@FindMate)
  )
)
# delete all off-switches
Landscape <- Landscape[Landscape$Values!=-9 & Landscape$Values!="NULL",]
rownames(Landscape) <- NULL
Demography <- Demography[Demography$Values!=-9 & Demography$Values!="NULL",]
rownames(Demography) <- NULL
Initialisation <- Initialisation[Initialisation$Values!=-9 & Initialisation$Values!="NULL" & Initialisation$Values!="-9 -9 -9 -9",]
rownames(Initialisation) <- NULL
Simulation <- Simulation[Simulation$Values!=-9,]
rownames(Simulation) <- NULL

# TODO: delete unset/unused variables
knitr::kable(Simulation, col.names = gsub("[.]", " ", names(Simulation)), caption = 'Simulation parameters')
knitr::kable(Landscape, col.names = gsub("[.]", " ", names(Landscape)), caption = 'Landscape parameters')
knitr::kable(Demography, col.names = gsub("[.]", " ", names(Demography)), caption = 'Demography parameters')
knitr::kable(Dispersal, col.names = gsub("[.]", " ", names(Dispersal)), caption = 'Dispersal parameters')
knitr::kable(Initialisation, col.names = gsub("[.]", " ", names(Initialisation)), caption = 'Initialisation parameters')
```

# References
